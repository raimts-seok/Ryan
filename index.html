<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë™íŒŒë²• íˆ¬ì ì „ëµ ë°±í…ŒìŠ¤í„°</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PapaParse (CSV Parser) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        /* ìˆ«ì ì…ë ¥ í™”ì‚´í‘œ ì œê±° */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        /* í…Œì´ë¸” ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 max-w-[1400px]">
        <!-- í—¤ë” -->
        <header class="mb-6 text-center">
            <h1 class="text-3xl font-bold text-indigo-800 tracking-tight">ğŸŒŠ ë™íŒŒë²•(SOXL) ë°±í…ŒìŠ¤í„°</h1>
            <p class="text-sm text-gray-600 mt-2 mb-4 font-medium">ì•ˆì „/ê³µì„¸ ëª¨ë“œ ê¸°ë°˜ ë™ì  ìì‚° ë°°ë¶„ ì „ëµ ì‹œë®¬ë ˆì´ì…˜</p>
            
            <!-- ë°ì´í„° ìƒíƒœ í‘œì‹œì¤„ -->
            <div class="flex justify-center items-center gap-3 mt-4">
                <span id="dbStatusBadge" class="flex items-center gap-2 text-sm font-bold text-gray-500 bg-white px-3 py-1 rounded-full shadow-sm">
                    <svg class="animate-spin h-4 w-4 text-indigo-500" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    ë°ì´í„° ì¤€ë¹„ ì¤‘...
                </span>
                <button onclick="loadFromGoogleSheet()" class="text-xs text-indigo-600 hover:text-indigo-800 font-bold underline">ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
                <label class="cursor-pointer text-xs text-gray-400 hover:text-gray-600 underline" title="êµ¬ê¸€ ì‹œíŠ¸ ì˜¤ë¥˜ ì‹œ ì‚¬ìš©">
                    CSV íŒŒì¼ ì„ íƒ
                    <input type="file" id="csvFile" accept=".csv" class="hidden">
                </label>
                
                <div id="manualDownloadLink" class="hidden text-xs text-red-500 bg-red-50 px-2 py-1 rounded">
                    ë¡œë“œ ì‹¤íŒ¨. <a href="https://docs.google.com/spreadsheets/d/1CY8hVPAXfPZZOfBgTaU5ygeLg4OXR14So_6dhfyoJjs/export?format=csv&gid=0" target="_blank" class="underline font-bold">ì—¬ê¸°ì„œ ë‹¤ìš´ë¡œë“œ</a> í›„ íŒŒì¼ ì„ íƒ.
                </div>
            </div>
        </header>

        <!-- ì„¤ì • íŒ¨ë„ (ì»´íŒ©íŠ¸ ëª¨ë“œ) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
            
            <!-- 1. ê¸°ë³¸ ì„¤ì • -->
            <div class="bg-white p-5 rounded-lg shadow-sm border-l-4 border-green-500">
                <h2 class="font-bold text-lg mb-8 text-gray-700">1. ê¸°ë³¸ ì„¤ì •</h2>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">ì´ˆê¸° íˆ¬ìê¸ˆ ($)</label>
                            <!-- ì½¤ë§ˆ ì…ë ¥ì„ ìœ„í•´ type="text"ë¡œ ë³€ê²½ ë° oninput í•¸ë“¤ëŸ¬ ì¶”ê°€ -->
                            <input type="text" id="initialCapital" value="10,000" oninput="this.value = this.value.replace(/[^0-9]/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ',');" class="w-full border border-gray-300 rounded px-2 py-1 text-right text-sm font-bold focus:ring-2 focus:ring-green-200 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">ìˆ˜ìˆ˜ë£Œ (%)</label>
                            <input type="number" id="brokerFee" value="0.044" step="0.001" class="w-full border border-gray-300 rounded px-2 py-1 text-right text-sm focus:ring-2 focus:ring-green-200 outline-none">
                            <div class="flex items-center justify-end mt-1 gap-1">
                                <input type="checkbox" id="useSecFee" checked class="w-3 h-3 text-green-600 rounded focus:ring-green-500 border-gray-300 cursor-pointer">
                                <label for="useSecFee" class="text-[10px] text-gray-500 cursor-pointer select-none">SEC Fee ë°˜ì˜</label>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">ì‹œì‘ì¼</label>
                            <input type="date" id="startDate" value="2024-01-02" class="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-green-200 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">ì¢…ë£Œì¼</label>
                            <input type="date" id="endDate" value="2025-12-03" class="w-full border border-gray-300 rounded px-2 py-1 text-sm focus:ring-2 focus:ring-green-200 outline-none">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. ëª¨ë“œë³„ ì„¤ì • -->
            <div class="bg-white p-5 rounded-lg shadow-sm border-l-4 border-yellow-400">
                <h2 class="font-bold text-lg mb-3 text-gray-700">2. ëª¨ë“œë³„ ì„¤ì • (%)</h2>
                
                <!-- ì•ˆì „ ëª¨ë“œ: mb-3ì„ mb-1ë¡œ ìˆ˜ì •í•˜ì—¬ ì•„ë˜ ê°„ê²© ì¤„ì„ -->
                <div class="mb-1 pb-2 border-b border-dashed border-gray-200">
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold text-blue-600 flex items-center gap-1.5 text-sm">
                            <span class="w-2.5 h-2.5 rounded-full bg-blue-500"></span> ì•ˆì „ (SF)
                        </span>
                    </div>
                    <div class="grid grid-cols-4 gap-2">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 mb-0.5 text-center">ë§¤ìˆ˜</label>
                            <input type="number" id="sfLoc" value="6.0" step="0.1" class="w-full border border-gray-300 rounded px-1 py-0.5 text-right text-sm font-bold text-gray-700 focus:ring-1 focus:ring-blue-400 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 mb-0.5 text-center">ë§¤ë„</label>
                            <input type="number" id="sfProfit" value="1.8" step="0.1" class="w-full border border-gray-300 rounded px-1 py-0.5 text-right text-sm font-bold text-gray-700 focus:ring-1 focus:ring-blue-400 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 mb-0.5 text-center">ë¶„í• </label>
                            <input type="number" id="sfSplit" value="7" class="w-full border border-gray-300 rounded px-1 py-0.5 text-right text-sm font-bold text-gray-700 focus:ring-1 focus:ring-blue-400 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 mb-0.5 text-center">ë³´ìœ ì¼</label>
                            <input type="number" id="sfHold" value="40" class="w-full border border-gray-300 rounded px-1 py-0.5 text-right text-sm font-bold text-gray-700 focus:ring-1 focus:ring-blue-400 outline-none">
                        </div>
                    </div>
                </div>

                <!-- ê³µì„¸ ëª¨ë“œ -->
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold text-red-600 flex items-center gap-1.5 text-sm">
                            <span class="w-2.5 h-2.5 rounded-full bg-red-500"></span> ê³µì„¸ (AG)
                        </span>
                    </div>
                    <div class="grid grid-cols-4 gap-2">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 mb-0.5 text-center">ë§¤ìˆ˜</label>
                            <input type="number" id="agLoc" value="3.6" step="0.1" class="w-full border border-gray-300 rounded px-1 py-1 text-right text-sm font-bold text-gray-700 focus:ring-1 focus:ring-red-400 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 mb-0.5 text-center">ë§¤ë„</label>
                            <input type="number" id="agProfit" value="5.6" step="0.1" class="w-full border border-gray-300 rounded px-1 py-1 text-right text-sm font-bold text-gray-700 focus:ring-1 focus:ring-red-400 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 mb-0.5 text-center">ë¶„í• </label>
                            <input type="number" id="agSplit" value="7" class="w-full border border-gray-300 rounded px-1 py-1 text-right text-sm font-bold text-gray-700 focus:ring-1 focus:ring-red-400 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 mb-0.5 text-center">ë³´ìœ ì¼</label>
                            <input type="number" id="agHold" value="7" class="w-full border border-gray-300 rounded px-1 py-1 text-right text-sm font-bold text-gray-700 focus:ring-1 focus:ring-red-400 outline-none">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. íˆ¬ìê¸ˆ ê°±ì‹  ì„¤ì • -->
            <div class="bg-white p-5 rounded-lg shadow-sm border-l-4 border-purple-500">
                <h2 class="font-bold text-lg mb-3 text-gray-700">3. íˆ¬ìê¸ˆ ê°±ì‹  ì„¤ì •</h2>
                <div class="space-y-3">
                    <!-- px-3 í´ë˜ìŠ¤ë¥¼ ì¶”ê°€í•˜ì—¬ ì•„ë˜ ë°•ìŠ¤ì™€ ì¢Œìš° ë¼ì¸ ì •ë ¬ -->
                    <div class="flex justify-between items-center border-b border-gray-100 pb-2 px-3">
                        <label class="text-xs font-bold text-gray-600">ê°±ì‹  ì£¼ê¸°</label>
                        <div class="flex items-center">
                            <input type="number" id="capitalCycle" value="10" class="w-16 border border-gray-300 rounded px-2 py-1 text-right text-sm focus:ring-2 focus:ring-purple-200 outline-none">
                            <span class="text-gray-500 text-xs ml-1 font-bold">ì¼</span>
                        </div>
                    </div>
                    <div class="bg-purple-50 p-3 rounded-lg border border-purple-100 space-y-2">
                        <div class="flex justify-between items-center">
                            <label class="text-xs font-bold text-blue-700">ìˆ˜ìµ ì‹œ ë°˜ì˜ë¥ </label>
                            <div class="flex items-center">
                                <input type="number" id="reinvestRate" value="85" class="w-14 border border-gray-300 rounded px-1 py-1 text-right text-sm font-bold text-blue-600 bg-white focus:ring-1 focus:ring-blue-400 outline-none">
                                <span class="text-gray-500 text-[10px] ml-1">%</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="text-xs font-bold text-red-600">ì†ì‹¤ ì‹œ ë°˜ì˜ë¥ </label>
                            <div class="flex items-center">
                                <input type="number" id="lossRate" value="35" class="w-14 border border-gray-300 rounded px-1 py-1 text-right text-sm font-bold text-red-500 bg-white focus:ring-1 focus:ring-red-400 outline-none">
                                <span class="text-gray-500 text-[10px] ml-1">%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- ì‹¤í–‰ ë²„íŠ¼ -->
        <div class="text-center mb-10">
            <button onclick="runBacktest()" class="w-full md:w-1/2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-200 text-lg transform hover:-translate-y-0.5">
                ğŸš€ ì„¤ì •ê°’ìœ¼ë¡œ ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰
            </button>
        </div>

        <!-- ê²°ê³¼ ì˜ì—­ -->
        <div id="resultArea" class="hidden animate-fade-in">
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 mb-6">
                <div class="bg-white p-3 rounded shadow text-center border-t-4 border-indigo-500">
                    <p class="text-xs text-gray-500 font-bold uppercase">ìµœì¢… ìì‚°</p>
                    <p class="text-[10px] text-gray-400 h-3"></p>
                    <p id="resFinalValue" class="text-lg font-extrabold text-indigo-700 mt-1">-</p>
                </div>
                <div class="bg-white p-3 rounded shadow text-center border-t-4 border-gray-400">
                    <p class="text-xs text-gray-500 font-bold uppercase">ëˆ„ì  ìˆ˜ìµë¥ </p>
                    <p class="text-[10px] text-gray-400 h-3"></p>
                    <p id="resTotalReturn" class="text-lg font-extrabold mt-1">-</p>
                </div>
                <div class="bg-white p-3 rounded shadow text-center border-t-4 border-green-500">
                    <p class="text-xs text-gray-500 font-bold uppercase">CAGR</p>
                    <p class="text-[10px] text-gray-400">(ì—°í‰ê· ë³µë¦¬ìˆ˜ìµë¥ )</p>
                    <p id="resCagr" class="text-lg font-extrabold text-green-600 mt-1">-</p>
                </div>
                <div class="bg-white p-3 rounded shadow text-center border-t-4 border-red-500">
                    <p class="text-xs text-gray-500 font-bold uppercase">MDD</p>
                    <p class="text-[10px] text-gray-400">(ìµœëŒ€ë‚™í­)</p>
                    <p id="resMdd" class="text-lg font-extrabold text-red-600 mt-1">-</p>
                </div>
                <div class="bg-white p-3 rounded shadow text-center border-t-4 border-orange-400">
                    <p class="text-xs text-gray-500 font-bold uppercase">Pain Index</p>
                    <p class="text-[10px] text-gray-400">(ì¼í‰ê· DD)</p>
                    <p id="resPain" class="text-lg font-extrabold text-orange-500 mt-1">-</p>
                </div>
                <div class="bg-white p-3 rounded shadow text-center border-t-4 border-purple-500">
                    <p class="text-xs text-gray-500 font-bold uppercase">GPR</p>
                    <p class="text-[10px] text-gray-400">(CAGR / Pain Index)</p>
                    <p id="resGpr" class="text-lg font-extrabold text-purple-600 mt-1">-</p>
                </div>
                <div class="bg-white p-3 rounded shadow text-center border-t-4 border-pink-500">
                    <p class="text-xs text-gray-500 font-bold uppercase">Calmar Ratio</p>
                    <p class="text-[10px] text-gray-400">(CAGR / MDD)</p>
                    <p id="resCalmar" class="text-lg font-extrabold text-pink-600 mt-1">-</p>
                </div>
            </div>

            <!-- ì°¨íŠ¸ ì˜ì—­ -->
            <div class="bg-white p-4 rounded-lg shadow mb-6 border border-gray-200" id="chartContainer">
                <h3 class="font-bold text-lg mb-2 px-2 text-gray-700">ğŸ“ˆ ìì‚° ë° ì£¼ê°€ ì¶”ì´</h3>
                <div class="relative h-[400px]">
                    <canvas id="strategyChart"></canvas>
                </div>
            </div>

            <!-- ìƒì„¸ ë‚´ì—­ í…Œì´ë¸” -->
            <div class="bg-white p-4 rounded-lg shadow overflow-x-auto" id="tableContainer">
                <h3 class="font-bold text-lg mb-3 px-2 text-gray-700">ğŸ“„ ì¼ë³„ ìƒì„¸ ê±°ë˜ ë‚´ì—­ (ì „ì²´)</h3>
                <table class="min-w-full text-xs text-right border-collapse">
                    <thead>
                        <tr class="bg-gray-100 text-gray-600 uppercase border-b">
                            <th class="py-3 px-3 text-center sticky left-0 bg-gray-100 border-r z-10">ë‚ ì§œ</th>
                            <th class="py-3 px-2 text-right">ì¢…ê°€</th>
                            <th class="py-3 px-2 text-right">ë“±ë½</th>
                            <th class="py-3 px-2 text-center">ëª¨ë“œ</th>
                            <th class="py-3 px-2 text-right">íˆ¬ìê¸ˆ</th>
                            <th class="py-3 px-2 text-right">ë§¤ìˆ˜ì—¬ë ¥</th>
                            <th class="py-3 px-2 text-center text-blue-600 font-bold">ë§¤ìˆ˜ëŸ‰</th>
                            <th class="py-3 px-2 text-center">í¬íŠ¸</th>
                            <th class="py-3 px-2 bg-blue-50 text-blue-700">ëª©í‘œê°€</th>
                            <th class="py-3 px-2 text-center bg-red-50 text-red-700">ë§¤ë„ì¼</th>
                            <th class="py-3 px-2 font-bold">í‰ê°€ì•¡</th>
                            <th class="py-3 px-2 text-gray-400">ì˜ˆìˆ˜ê¸ˆ</th>
                            <th class="py-3 px-2">ì‹¤í˜„ìˆ˜ìµ</th>
                            <th class="py-3 px-2 text-gray-400">ë³´ìœ </th>
                        </tr>
                    </thead>
                    <tbody id="logTableBody" class="text-gray-700 divide-y">
                        <!-- JSë¡œ ì¶”ê°€ë¨ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ìŠ¤í¬ë¦½íŠ¸ ì˜ì—­ -->
    <script>
        // --- ìƒìˆ˜ ë° ì „ì—­ ë³€ìˆ˜ ---
        const SHEET_ID = '1CY8hVPAXfPZZOfBgTaU5ygeLg4OXR14So_6dhfyoJjs';
        const SHEET_NAME = 'DBALL';
        const SEC_FEE_RATE = 0.0000278;
        const DECIMAL_4_START = new Date('2011-01-03');
        const DECIMAL_4_END = new Date('2021-03-01');
        
        let rawPriceData = [];
        let rawModeData = [];
        let chartInstance = null;

        window.addEventListener('load', loadFromGoogleSheet);

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        // ë‚´ë¦¼(ì ˆì‚¬) ì²˜ë¦¬ í•¨ìˆ˜
        function floorVal(val, decimals) {
            const factor = Math.pow(10, decimals);
            return Math.floor(val * factor) / factor;
        }

        // ë°˜ì˜¬ë¦¼ ì²˜ë¦¬ í•¨ìˆ˜ (Math.roundë¥¼ ì‚¬ìš©í•˜ë˜, ìë¦¿ìˆ˜ë¥¼ ì§€ì • ê°€ëŠ¥í•˜ê²Œ í™•ì¥)
        function roundVal(val, decimals) {
            const factor = Math.pow(10, decimals);
            return Math.round(val * factor) / factor;
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            let s = String(dateStr).trim();
            
            // Aggressive cleaning: remove non-essential chars (spaces, commas, parentheses, zero-width space)
            s = s.replace(/\s*\(.*\)\s*$/, '')
                 .replace(/\.$/, '')
                 .replace(/[\s,]/g, '')
                 .replace(/\u200B/g, ''); // Remove zero-width space

            // Convert all common separators (., /) to hyphen (-)
            s = s.replace(/[\.\/]/g, '-');
            
            const parts = s.split('-');
            
            if (parts.length === 3) {
                // Ensure 4-digit year (handles 25-08-15 -> 2025-08-15)
                if (parts[0].length === 2) {
                    parts[0] = '20' + parts[0];
                }
            } else {
                return null; // Invalid format
            }
            
            // Attempt to create Date object
            const date = new Date(parts.join('-'));
            
            // Use date.getTime() to check validity robustly
            return isNaN(date.getTime()) ? null : date;
        }


        function formatNum(num, fixed=2) {
            return num.toLocaleString(undefined, {minimumFractionDigits: fixed, maximumFractionDigits: fixed});
        }

        // --- ë°ì´í„° ë¡œë“œ ---
        async function loadFromGoogleSheet() {
            const badge = document.getElementById('dbStatusBadge');
            const manualLink = document.getElementById('manualDownloadLink');
            
            badge.className = "flex items-center gap-2 text-sm font-bold text-indigo-600 animate-pulse bg-white px-3 py-1 rounded-full shadow-sm";
            badge.innerHTML = `
                <svg class="animate-spin h-4 w-4 text-indigo-500" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                ë°ì´í„° ë¡œë”© ì¤‘...
            `;
            if (manualLink) manualLink.classList.add('hidden');

            // Cache Busting: URLì— í˜„ì¬ ì‹œê°„ì„ ì¶”ê°€í•˜ì—¬ ê°•ì œë¡œ ìƒˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜´
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}&_t=${Date.now()}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("Network response was not ok");
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    complete: function(results) {
                        processCSV(results.data);
                    },
                    error: function(err) { throw err; }
                });
            } catch (error) {
                console.error("Data Load Error:", error);
                badge.className = "flex items-center gap-2 text-sm font-bold text-red-600 bg-white px-3 py-1 rounded-full shadow-sm cursor-pointer";
                badge.innerHTML = `âš ï¸ ë¡œë“œ ì‹¤íŒ¨ (ì—¬ê¸°ë¥¼ ëˆŒëŸ¬ ì¬ì‹œë„)`;
                badge.onclick = loadFromGoogleSheet;
                if (manualLink) manualLink.classList.remove('hidden');
            }
        }

        // CSV Upload Handler
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            Papa.parse(file, {
                complete: function(results) { processCSV(results.data); }
            });
        });

        function processCSV(data) {
            rawPriceData = [];
            rawModeData = [];

            const targetDateStr = '2025-08-15';
            let foundTargetDate = false;

            for (let i = 132; i < data.length; i++) {
                const row = data[i];
                
                if (!row[0] || !row[1]) continue;

                const date = parseDate(row[0]);
                const priceStr = String(row[1]).replace(/,/g, '');
                const price = parseFloat(priceStr);

                // íŒŒì‹± ì„±ê³µ ë° ìœ íš¨í•œ ê°€ê²©ì¼ ê²½ìš°ì—ë§Œ ë°ì´í„° ì¶”ê°€
                if (date && !isNaN(price)) {
                    rawPriceData.push({ date: date, close: price });
                    if (date.toISOString().slice(0, 10) === targetDateStr) {
                         foundTargetDate = true;
                    }
                }
            }
            
            // ëª¨ë“œ ë°ì´í„° ë¡œë”©
            for (let i = 3; i < data.length; i++) {
                const row = data[i];
                if (!row[4] || !row[7]) continue; 
                const date = parseDate(row[4]);
                const mode = row[7].trim();
                if (date && mode) rawModeData.push({ date: date, mode: mode });
            }

            rawPriceData.sort((a, b) => a.date - b.date);
            rawModeData.sort((a, b) => a.date - b.date);

            const badge = document.getElementById('dbStatusBadge');
            const manualLink = document.getElementById('manualDownloadLink');
            
            if (rawPriceData.length > 0) {
                const startY = rawPriceData[0].date.getFullYear();
                const endY = rawPriceData[rawPriceData.length-1].date.getFullYear();
                
                // --- ìµœì¢… ë””ë²„ê¹… ë¡œê·¸ (ë¬¸ì œ í•´ê²° í™•ì¸ìš©) ---
                console.log("--- [ë°ì´í„° ë¡œë“œ ìµœì¢… í™•ì¸] ---");
                console.log(`ì´ ì£¼ê°€ ë°ì´í„° ê°œìˆ˜: ${rawPriceData.length}ê°œ`);
                if (foundTargetDate) {
                    console.log('âœ… 2025-08-15 ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë¡œë“œë˜ì–´ ë°±í…ŒìŠ¤íŠ¸ì— ì‚¬ìš©ë  ì˜ˆì •ì…ë‹ˆë‹¤.');
                } else {
                    // íŒŒì‹± ë¡œì§ì„ ìˆ˜ì •í–ˆìŒì—ë„ ì‹¤íŒ¨í•˜ë©´ ì›ë³¸ ë°ì´í„° í˜•ì‹ì— ë¬¸ì œê°€ ìˆìŒì„ ë‹¤ì‹œ ì•Œë¦¼
                    console.error('âŒ ë‚ ì§œ íŒŒì‹± ë¡œì§ì„ ê°•í™”í–ˆìœ¼ë‚˜ 2025-08-15 ë°ì´í„°ê°€ ì—¬ì „íˆ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì›ë³¸ CSV íŒŒì¼ì˜ 2025-08-15 ë‚ ì§œ ì…€ì„ í™•ì¸í•´ ì£¼ì„¸ìš”. (ë‚ ì§œê°€ ì‰¼í‘œë‚˜ ë‹¤ë¥¸ ì´ìƒ ë¬¸ìë¥¼ í¬í•¨í•˜ëŠ”ì§€)');
                }
                console.log("------------------------");
                
                badge.className = "flex items-center gap-2 text-sm font-bold text-green-600 bg-white px-3 py-1 rounded-full shadow-sm";
                badge.innerHTML = `ğŸŸ¢ ë°ì´í„° ì¤€ë¹„ë¨ (${startY}~${endY})`;
                badge.onclick = null;
                if (manualLink) manualLink.classList.add('hidden');
            } else {
                badge.className = "flex items-center gap-2 text-sm font-bold text-yellow-600 bg-white px-3 py-1 rounded-full shadow-sm";
                badge.innerHTML = `âš ï¸ ë°ì´í„° ì—†ìŒ (í˜•ì‹ í™•ì¸ í•„ìš”)`;
            }
        }

        // --- Backtest Engine ---
        function runBacktest() {
            if (rawPriceData.length === 0) { alert("ë°ì´í„° ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”."); return; }

            // ì½¤ë§ˆ ì œê±° í›„ íŒŒì‹±
            const inputInitialCapital = parseFloat(document.getElementById('initialCapital').value.replace(/,/g, ''));
            const inputBrokerFee = parseFloat(document.getElementById('brokerFee').value);
            const useSecFee = document.getElementById('useSecFee').checked; // SEC Fee ì²´í¬ ì—¬ë¶€ í™•ì¸
            const startDate = new Date(document.getElementById('startDate').value);
            
            // ì¢…ë£Œì¼ ë³´ì •: ì‚¬ìš©ìê°€ '2025-12-02'ë¥¼ ì„ íƒí•˜ë©´ 00:00:00ì´ ë˜ì–´
            // ë°ì´í„°ì˜ 12-02ê°€ ì‹œê°„ì°¨ë¡œ ì¸í•´ ì˜ë¦´ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì¢…ë£Œì¼ì˜ ì‹œê°„ì„ 23:59:59ë¡œ ê°•ì œ ì„¤ì •
            const endDateInput = new Date(document.getElementById('endDate').value);
            const endDate = new Date(endDateInput);
            endDate.setHours(23, 59, 59, 999);

            const sf = {
                loc: 1 + (parseFloat(document.getElementById('sfLoc').value)/100),
                profit: 1 + (parseFloat(document.getElementById('sfProfit').value)/100),
                split: parseInt(document.getElementById('sfSplit').value),
                hold: parseInt(document.getElementById('sfHold').value)
            };
            const ag = {
                loc: 1 + (parseFloat(document.getElementById('agLoc').value)/100),
                profit: 1 + (parseFloat(document.getElementById('agProfit').value)/100),
                split: parseInt(document.getElementById('agSplit').value),
                hold: parseInt(document.getElementById('agHold').value)
            };
            
            const capitalCycle = parseInt(document.getElementById('capitalCycle').value);
            const reinvestRate = parseFloat(document.getElementById('reinvestRate').value) / 100;
            const lossRate = parseFloat(document.getElementById('lossRate').value) / 100;

            let mergedData = [];
            let currentModeIdx = 0;
            
            // 1. Find the index of the first data point *on or after* startDate
            let priceStartIndex = rawPriceData.findIndex(p => p.date >= startDate);

            if (priceStartIndex === -1) {
                alert("ì„ íƒëœ ì‹œì‘ì¼ ì´í›„ì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            // 2. Include the day *before* startDate if available (for 'prevClose')
            let loopStart = priceStartIndex;
            if (priceStartIndex > 0) {
                loopStart = priceStartIndex - 1;
            }

            // 3. Populate mergedData from the reference day (if exists) up to endDate
            for (let i = loopStart; i < rawPriceData.length; i++) {
                const p = rawPriceData[i];

                // Stop if date exceeds the user's endDate
                if (p.date > endDate) break;

                // --- Mode Finding Logic ---
                while (currentModeIdx < rawModeData.length - 1 && rawModeData[currentModeIdx + 1].date <= p.date) {
                    currentModeIdx++;
                }
                
                let mode = rawModeData.length > 0 ? rawModeData[currentModeIdx].mode : 'SF'; 
                if (rawModeData.length > 0 && p.date < rawModeData[0].date) mode = rawModeData[0].mode;
                // --- End Mode Finding Logic ---

                mergedData.push({ date: p.date, close: p.close, mode: mode });
            }

            if (mergedData.length < 2) { 
                alert("ë°±í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•œ ìµœì†Œ 2ì¼(ì „ì¼ ì¢…ê°€ ë° ì‹œì‘ì¼)ì˜ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."); 
                return; 
            } 

            // --- ë””ë²„ê¹… ë¡œê·¸ 1: ë³‘í•©ëœ ë°ì´í„° í™•ì¸ ---
            console.log(`\n--- [ë°±í…ŒìŠ¤íŠ¸ ë°ì´í„° ë³‘í•© ê²°ê³¼] ---`);
            console.log(`ì´ ë³‘í•©ëœ ë°ì´í„° ê°œìˆ˜: ${mergedData.length}ì¼`);
            console.log(`[0] ê¸°ì¤€ì¼(ì „ì¼): ${mergedData[0].date.toISOString().slice(0, 10)}`);
            console.log(`[1] ì‹¤ì œ ë§¤ë§¤ ì‹œì‘ì¼: ${mergedData[1].date.toISOString().slice(0, 10)}`);
            if (mergedData.length > 2) {
                console.log(`[2] ë‹¤ìŒ ê±°ë˜ì¼: ${mergedData[2].date.toISOString().slice(0, 10)}`);
            }
            console.log("---------------------------------");
            // ----------------------------------------

            let investCapital = inputInitialCapital;
            let cash = inputInitialCapital;
            let holdings = []; 
            let history = [];
            let daysSinceUpdate = 0;
            let periodProfit = 0;
            let cumulativeProfit = 0;

            
            // ë£¨í”„ëŠ” ë‘ ë²ˆì§¸ ë‚ ì§œ(mergedData[1], ì¦‰ ì‹œì‘ì¼)ë¶€í„° ì‹œì‘í•˜ì—¬ ì²« ë‚ ì§œ(mergedData[0], ì „ì¼)ì˜ ì¢…ê°€ë¥¼ ì „ì¼ ê¸°ì¤€ìœ¼ë¡œ ì‚¬ìš©í•˜ì—¬ ë§¤ë§¤ ë¡œì§ ì‹¤í–‰
            for (let i = 1; i < mergedData.length; i++) {
                const curr = mergedData[i];
                const prev = mergedData[i-1];
                const date = curr.date;
                const close = curr.close;
                const prevClose = prev.close;
                const mode = curr.mode;
                const dateStr = date.toISOString().slice(0, 10);
                
                if (dateStr === '2025-08-15') {
                    console.log(`ğŸ‰ [LOOP CONFIRM] 2025-08-15ì˜ ê±°ë˜ ë¡œì§ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.`);
                }


                let precPrice = 2, precSeed = 0;
                if (date >= DECIMAL_4_START && date <= DECIMAL_4_END) {
                    precPrice = 4; precSeed = 2;
                }

                const startHoldingsCnt = holdings.length;

                // daysSinceUpdate increment
                daysSinceUpdate++;

                let buyingPower = cash;
                let nextHoldings = [];
                let soldToday = false;

                for (let h of holdings) {
                    let rule = (h.mode === 'SF' || h.mode === 'ì•ˆì „') ? sf : ag;
                    
                    // NEW: ëª©í‘œ ë§¤ë„ê°€ (targetPrice) - precPrice + ë°˜ì˜¬ë¦¼
                    let targetPrice = roundVal(h.buyPrice * rule.profit, precPrice);
                    
                    let isSold = false, sellPrice = 0;

                    if (h.daysHeld >= (rule.hold - 1)) { isSold = true; sellPrice = close; }
                    else if (close >= targetPrice) { isSold = true; sellPrice = close; }

                    if (isSold) {
                        let revenue = sellPrice * h.qty;
                        
                        // NEW: ìœ„íƒ ìˆ˜ìˆ˜ë£Œ (feeBroker) - precPrice + ë‚´ë¦¼
                        let feeBroker = floorVal(revenue * (inputBrokerFee/100), precPrice);
                        
                        // SEC Fee ì¡°ê±´ë¶€ ê³„ì‚°
                        // NEW: SEC Fee (feeSec) - precPrice + ë‚´ë¦¼ (ê¸°ì¡´ toFixedì—ì„œ floorValë¡œ ë³€ê²½)
                        let feeSec = 0;
                        if (useSecFee) {
                            let tempSecFee = revenue * SEC_FEE_RATE;
                            feeSec = floorVal(tempSecFee, precPrice);
                        }
                        
                        let fee = feeBroker + feeSec;
                        
                        let netRev = revenue - fee;
                        let profit = netRev - (h.buyPrice * h.qty) - (h.buyFee || 0); // ì†Œìˆ˜ì  ì²˜ë¦¬ ì•ˆ ëœ ì›ë³¸ ì´ìµ

                        // NEW: ì‹¤í˜„ ì†ìµ (profit) - precPrice + ë°˜ì˜¬ë¦¼ (í™”ë©´ í‘œì‹œìš©)
                        let roundedProfit = roundVal(profit, precPrice);
                        
                        // NEW: ì˜ˆìˆ˜ê¸ˆ (cash) - precPrice + ë°˜ì˜¬ë¦¼
                        let roundedNetRev = roundVal(netRev, precPrice);

                        cash = roundVal(cash + roundedNetRev, precPrice); // ì˜ˆìˆ˜ê¸ˆ ì—…ë°ì´íŠ¸ ì‹œì—ë„ precPrice ë°˜ì˜¬ë¦¼ ì ìš©
                        cumulativeProfit += roundedProfit; // í™”ë©´ í‘œì‹œìš© ëˆ„ì ì€ ë°˜ì˜¬ë¦¼ ê°’ ì‚¬ìš©
                        
                        // [ìˆ˜ì •ë¨] íˆ¬ìê¸ˆ ê°±ì‹ ìš© ê¸°ê°„ ìˆ˜ìµ í•©ì‚°ì€ 'ì›ë³¸ ê°’(profit)'ì„ ê·¸ëŒ€ë¡œ ë”í•¨
                        periodProfit += profit; 
                        
                        soldToday = true;
                        h.sellDate = date;
                    } else {
                        h.daysHeld++;
                        nextHoldings.push(h);
                    }
                }
                holdings = nextHoldings;

                let rule = (mode === 'SF' || mode === 'ì•ˆì „') ? sf : ag;
                let splitCnt = (mode === 'SF' || mode === 'ì•ˆì „') ? sf.split : ag.split;

                // NEW: ëª©í‘œ ë§¤ìˆ˜ê°€ (targetBuyPrice) - precPrice + ë‚´ë¦¼
                let targetBuyPrice = floorVal(prevClose * rule.loc, precPrice);
                let buyExecutedQty = 0;
                let newPort = null;

                if (startHoldingsCnt < splitCnt) {
                    if (close <= targetBuyPrice) {
                        // NEW: 1íšŒ ë¶„í•  ì‹œë“œ (onePortCash) - precSeed + ë‚´ë¦¼
                        let onePortCash = floorVal(investCapital / splitCnt, precSeed);

                        if (targetBuyPrice > 0) {
                            // NEW: ë§¤ìˆ˜ ìˆ˜ëŸ‰ (qty) - ì •ìˆ˜ + ë‚´ë¦¼
                            let qty = Math.floor(onePortCash / targetBuyPrice);
                            let estAmt = qty * targetBuyPrice;
                            
                            // ë§¤ìˆ˜ ìˆ˜ìˆ˜ë£Œ ì‚°ì • ì‹œ, ì •ë°€ë„ ê¸°ì¤€ì€ precPrice + ë‚´ë¦¼ìœ¼ë¡œ ìœ ì§€
                            let estFee = floorVal(estAmt * (inputBrokerFee/100), precPrice);

                            if ((estAmt + estFee) > buyingPower) {
                                // ë§¤ìˆ˜ ì—¬ë ¥ì´ ë¶€ì¡±í•˜ë©´ êµ¬ë§¤ ê°€ëŠ¥ ìˆ˜ëŸ‰ ë‹¤ì‹œ ê³„ì‚° (ë‚´ë¦¼)
                                qty = Math.floor(buyingPower / (targetBuyPrice * (1 + (inputBrokerFee/100))));
                            }

                            if (qty > 0) {
                                let buyAmt = qty * close;
                                let fee = floorVal(buyAmt * (inputBrokerFee/100), precPrice);
                                let totalCost = buyAmt + fee;

                                if (totalCost <= cash) {
                                    cash -= totalCost;
                                    
                                    // ì˜ˆìˆ˜ê¸ˆ ì°¨ê° í›„ precPrice ë°˜ì˜¬ë¦¼
                                    cash = roundVal(cash, precPrice); 

                                    buyExecutedQty = qty;
                                    newPort = {
                                        buyDate: date, buyPrice: close, qty: qty, mode: mode, daysHeld: 0, buyFee: fee, sellDate: null
                                    };
                                    holdings.push(newPort);
                                }
                            }
                        }
                    }
                }

                // --- CAPITAL UPDATE LOGIC MOVED HERE ---
                // Update happens AFTER trading on the cycle day (e.g., Day 10)
                // This ensures Day 10 profits are included, and Day 11 uses new capital.
                if (daysSinceUpdate >= capitalCycle) {
                    let profitToReinvest = periodProfit * (periodProfit > 0 ? reinvestRate : lossRate);
                    investCapital += profitToReinvest;
                    
                    // NEW: ì´ íˆ¬ìê¸ˆ (investCapital) - precSeed + ë°˜ì˜¬ë¦¼
                    investCapital = roundVal(investCapital, precSeed);
                    
                    periodProfit = 0;
                    daysSinceUpdate = 0;
                }
                // ---------------------------------------

                let stockVal = holdings.reduce((sum, h) => sum + (h.qty * close), 0);
                let totalQty = holdings.reduce((sum, h) => sum + h.qty, 0);
                let totalAsset = cash + stockVal;

                history.push({
                    date: date, close: close, mode: mode,
                    capital: investCapital, bp: buyingPower,
                    targetBuy: targetBuyPrice, buyQty: buyExecutedQty, newPort: newPort,
                    val: totalAsset, cash: cash, profit: cumulativeProfit,
                    qty: totalQty, cnt: holdings.length, sold: soldToday
                });
            }

            // --- ë””ë²„ê¹… ë¡œê·¸ 3: ìµœì¢… ê¸°ë¡ëœ ë‚´ì—­ í™•ì¸ ---
            const finalHistoryDates = history.map(h => h.date.toISOString().slice(0, 10));
            console.log(`\n--- [ìµœì¢… ê¸°ë¡ ë‚´ì—­ í™•ì¸] ---`);
            console.log(`ì´ ê¸°ë¡ëœ ì¼ìˆ˜: ${history.length}ì¼`);
            if (finalHistoryDates.includes('2025-08-15')) {
                console.log('âœ… 2025-08-15ê°€ ìµœì¢… ê¸°ë¡ì— í¬í•¨ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                console.error('âŒ 2025-08-15ê°€ ìµœì¢… ê¸°ë¡ì— í¬í•¨ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            }
            console.log(`ê¸°ë¡ ì‹œì‘ì¼: ${finalHistoryDates[0]}`);
            console.log(`ê¸°ë¡ ì¢…ë£Œì¼: ${finalHistoryDates[finalHistoryDates.length - 1]}`);
            console.log("---------------------------------");
            
            displayResults(history, inputInitialCapital);
        }

        function displayResults(history, startVal) {
            document.getElementById('resultArea').classList.remove('hidden');

            const last = history[history.length - 1];
            const endVal = last.val;
            const totalProfit = endVal - startVal;
            const ret = (totalProfit / startVal) * 100;

            const days = (last.date - history[0].date) / (1000 * 60 * 60 * 24);
            const years = days / 365.25;
            const cagr = years > 0 ? (Math.pow(endVal/startVal, 1/years) - 1) * 100 : 0;

            let maxPeak = -Infinity, mdd = 0, sumDD = 0;
            let dds = [];
            history.forEach(h => {
                if (h.val > maxPeak) maxPeak = h.val;
                let dd = (h.val - maxPeak) / maxPeak;
                if (dd < mdd) mdd = dd;
                sumDD += dd;
                dds.push(dd);
            });
            mdd *= 100;

            const painIndex = Math.abs(sumDD / history.length) * 100;
            const gpr = painIndex > 0 ? cagr / painIndex : 0;
            const calmar = mdd !== 0 ? cagr / Math.abs(mdd) : 0;

            document.getElementById('resFinalValue').innerText = `$${formatNum(endVal)}`;
            document.getElementById('resTotalReturn').innerText = `${formatNum(ret)}%`;
            document.getElementById('resTotalReturn').className = `text-xl font-extrabold mt-1 ${ret >= 0 ? 'text-red-500' : 'text-blue-600'}`;
            document.getElementById('resCagr').innerText = `${formatNum(cagr)}%`;
            document.getElementById('resMdd').innerText = `${formatNum(mdd)}%`;
            document.getElementById('resPain').innerText = `${formatNum(painIndex)}%`;
            document.getElementById('resGpr').innerText = formatNum(gpr);
            document.getElementById('resCalmar').innerText = formatNum(calmar);

            drawChart(history, dds);
            drawTable(history);
        }

        function drawChart(history, dds) {
            const ctx = document.getElementById('strategyChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            const labels = history.map(h => h.date.toISOString().slice(0, 10));
            const dataVal = history.map(h => h.val);
            const dataClose = history.map(h => h.close);
            const dataDD = dds.map(d => d * 100);

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ìì‚° ê°€ì¹˜ ($)',
                            data: dataVal,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            yAxisID: 'y',
                            tension: 0.1,
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: 'SOXL ì£¼ê°€ ($)',
                            data: dataClose,
                            borderColor: 'rgb(255, 99, 132)',
                            yAxisID: 'y1',
                            tension: 0.1,
                            pointRadius: 1, 
                            borderWidth: 1, 
                            fill: false
                        },
                        {
                            label: 'Drawdown (%)',
                            data: dataDD,
                            borderColor: 'rgba(153, 102, 255, 0.8)',
                            backgroundColor: 'rgba(153, 102, 255, 0.2)',
                            yAxisID: 'y2',
                            type: 'line',
                            fill: true,
                            pointRadius: 0,
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { ticks: { maxTicksLimit: 8, maxRotation: 0 } },
                        y: { 
                            position: 'right', 
                            grid: { display: false },
                            title: { display: true, text: 'Asset Value ($)' }
                        },
                        y1: { 
                            position: 'left', 
                            grid: { color: '#f3f4f6' },
                            title: { display: true, text: 'SOXL Price ($)' }
                        },
                        y2: {
                            position: 'right',
                            min: -100, max: 0,
                            display: false 
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) {
                                        label += formatNum(context.parsed.y);
                                        if (context.dataset.yAxisID === 'y2') label += '%';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        function drawTable(history) {
            const tbody = document.getElementById('logTableBody');
            tbody.innerHTML = '';
            
            const rows = history.map((h, i) => {
                const dateStr = h.date.toISOString().slice(0, 10);
                const modeClass = h.mode === 'AG' ? 'text-red-500 font-bold' : 'text-blue-500 font-bold';
                const buyClass = h.buyQty > 0 ? 'bg-blue-50 font-bold text-blue-600' : 'text-gray-300';
                
                let sellDateStr = '-';
                if (h.newPort) {
                    if (h.newPort.sellDate) {
                        sellDateStr = `<span class="text-red-600 font-bold">${h.newPort.sellDate.toISOString().slice(0, 10)}</span>`;
                    } else {
                        sellDateStr = '<span class="text-gray-400 text-[10px]">ë³´ìœ ì¤‘</span>';
                    }
                }
                
                let changeRate = 0;
                if (i > 0) {
                    const prevClose = history[i-1].close;
                    changeRate = ((h.close - prevClose) / prevClose) * 100;
                }
                const changeClass = changeRate >= 0 ? 'text-red-600' : 'text-blue-600';
                const changeSign = changeRate >= 0 ? '+' : '';
                const profitClass = h.profit >= 0 ? 'text-red-600' : 'text-blue-600';

                return `
                    <tr class="hover:bg-gray-50 transition-colors border-b border-gray-100">
                        <td class="py-2 px-2 text-center text-xs text-gray-500 sticky left-0 bg-white border-r border-gray-100">${dateStr}</td>
                        <td class="py-2 px-2 text-right font-medium text-gray-700">${formatNum(h.close, 2)}</td>
                        <td class="py-2 px-2 text-right text-[11px] ${changeClass}">${changeSign}${formatNum(changeRate)}%</td>
                        <td class="py-2 px-2 text-center text-xs ${modeClass}">${h.mode}</td>
                        <td class="py-2 px-2 text-right text-gray-600 font-mono">${formatNum(h.capital, 0)}</td>
                        <td class="py-2 px-2 text-right text-gray-400 font-mono">${formatNum(h.bp, 0)}</td>
                        <td class="py-2 px-2 text-center ${buyClass}">${h.buyQty > 0 ? h.buyQty : '-'}</td>
                        <td class="py-2 px-2 text-center font-bold text-gray-600">${h.cnt}</td>
                        <td class="py-2 px-2 text-right text-blue-600 bg-blue-50/50 text-[11px]">${formatNum(h.targetBuy, 2)}</td>
                        <td class="py-2 px-2 text-center bg-red-50/50">${sellDateStr}</td>
                        <td class="py-2 px-2 text-right font-bold text-gray-800">${formatNum(h.val, 0)}</td>
                        <td class="py-2 px-2 text-right text-gray-400 font-mono">${formatNum(h.cash, 0)}</td>
                        <td class="py-2 px-2 text-right font-medium ${profitClass}">${formatNum(h.profit, 0)}</td>
                        <td class="py-2 px-2 text-right text-gray-500">${formatNum(h.qty, 0)}</td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = rows;
        }
    </script>
</body>
</html>