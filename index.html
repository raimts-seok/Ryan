<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë™íŒŒë²• íˆ¬ì ì „ëµ ë°±í…ŒìŠ¤í„°</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PapaParse (CSV Parser) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        /* ìˆ«ì ì…ë ¥ í™”ì‚´í‘œ ì œê±° */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        /* í…Œì´ë¸” ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 max-w-[1400px]">
        <!-- í—¤ë” -->
        <header class="mb-6 text-center">
            <h1 class="text-3xl font-bold text-indigo-800 tracking-tight">ğŸŒŠ ë™íŒŒë²•(SOXL) ë°±í…ŒìŠ¤í„°</h1>
            <p class="text-sm text-gray-600 mt-2 mb-4 font-medium">ì•ˆì „/ê³µì„¸ ëª¨ë“œ ê¸°ë°˜ ë™ì  ìì‚° ë°°ë¶„ ì „ëµ ì‹œë®¬ë ˆì´ì…˜</p>
            
            <!-- ë°ì´í„° ìƒíƒœ í‘œì‹œì¤„ -->
            <div class="flex justify-center items-center gap-3 mt-4">
                <span id="dbStatusBadge" class="flex items-center gap-2 text-sm font-bold text-gray-500 bg-white px-3 py-1 rounded-full shadow-sm">
                    <svg class="animate-spin h-4 w-4 text-indigo-500" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    ë°ì´í„° ì¤€ë¹„ ì¤‘...
                </span>
                <button onclick="loadFromGoogleSheet()" class="text-xs text-indigo-600 hover:text-indigo-800 font-bold underline">ë°ì´í„° ìƒˆë¡œê³ ì¹¨</button>
                <label class="cursor-pointer text-xs text-gray-400 hover:text-gray-600 underline" title="êµ¬ê¸€ ì‹œíŠ¸ ì˜¤ë¥˜ ì‹œ ì‚¬ìš©">
                    CSV íŒŒì¼ ì„ íƒ
                    <input type="file" id="csvFile" accept=".csv" class="hidden">
                </label>
                
                <div id="manualDownloadLink" class="hidden text-xs text-red-500 bg-red-50 px-2 py-1 rounded">
                    ë¡œë“œ ì‹¤íŒ¨. <a href="https://docs.google.com/spreadsheets/d/1CY8hVPAXfPZZOfBgTaU5ygeLg4OXR14So_6dhfyoJjs/export?format=csv&gid=0" target="_blank" class="underline font-bold">ì—¬ê¸°ì„œ ë‹¤ìš´ë¡œë“œ</a> í›„ íŒŒì¼ ì„ íƒ.
                </div>
            </div>
        </header>

        <!-- ì„¤ì • íŒ¨ë„ (4ì—´ ë ˆì´ì•„ì›ƒ) -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 mb-6">
            
            <!-- 1. ê¸°ë³¸ ì„¤ì • -->
            <div class="bg-white p-5 rounded-lg shadow-sm border-l-4 border-green-500">
                <h2 class="font-bold text-lg mb-8 text-gray-700">1. ê¸°ë³¸ ì„¤ì •</h2>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">ì´ˆê¸° íˆ¬ìê¸ˆ ($)</label>
                            <!-- ì½¤ë§ˆ ì…ë ¥ì„ ìœ„í•´ type="text"ë¡œ ë³€ê²½ ë° oninput í•¸ë“¤ëŸ¬ ì¶”ê°€ -->
                            <input type="text" id="initialCapital" value="10,000" oninput="this.value = this.value.replace(/[^0-9]/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ',');" class="w-full border border-gray-300 rounded px-2 py-1 text-right text-sm font-bold focus:ring-2 focus:ring-green-200 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">ìˆ˜ìˆ˜ë£Œ (%)</label>
                            <input type="number" id="brokerFee" value="0.044" step="0.001" class="w-full border border-gray-300 rounded px-2 py-1 text-right text-sm focus:ring-2 focus:ring-green-200 outline-none">
                            <div class="flex items-center justify-end mt-1 gap-1">
                                <input type="checkbox" id="useSecFee" checked class="w-3 h-3 text-green-600 rounded focus:ring-green-500 border-gray-300 cursor-pointer">
                                <label for="useSecFee" class="text-[10px] text-gray-500 cursor-pointer select-none">SEC Fee ë°˜ì˜</label>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">ì‹œì‘ì¼</label>
                            <input type="date" id="startDate" value="2024-01-02" class="w-full border border-gray-300 rounded px-2 py-1 text-xs focus:ring-2 focus:ring-green-200 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">ì¢…ë£Œì¼</label>
                            <input type="date" id="endDate" value="2025-12-03" class="w-full border border-gray-300 rounded px-2 py-1 text-xs focus:ring-2 focus:ring-green-200 outline-none">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. ëª¨ë“œë³„ ì„¤ì • -->
            <div class="bg-white p-5 rounded-lg shadow-sm border-l-4 border-yellow-400">
                <h2 class="font-bold text-lg mb-3 text-gray-700">2. ëª¨ë“œë³„ ì„¤ì • (%)</h2>
                
                <!-- ì•ˆì „ ëª¨ë“œ: mb-3ì„ mb-1ë¡œ ìˆ˜ì •í•˜ì—¬ ì•„ë˜ ê°„ê²© ì¤„ì„ -->
                <div class="mb-1 pb-2 border-b border-dashed border-gray-200">
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold text-blue-600 flex items-center gap-1.5 text-sm">
                            <span class="w-2.5 h-2.5 rounded-full bg-blue-500"></span> ì•ˆì „ (SF)
                        </span>
                    </div>
                    <div class="grid grid-cols-4 gap-2">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 mb-0.5 text-center">ë§¤ìˆ˜</label>
                            <input type="number" id="sfLoc" value="6.0" step="0.1" class="w-full border border-gray-300 rounded px-1 py-0.5 text-right text-sm font-bold text-gray-700 focus:ring-1 focus:ring-blue-400 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 mb-0.5 text-center">ë§¤ë„</label>
                            <input type="number" id="sfProfit" value="1.8" step="0.1" class="w-full border border-gray-300 rounded px-1 py-0.5 text-right text-sm font-bold text-gray-700 focus:ring-1 focus:ring-blue-400 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 mb-0.5 text-center">ë¶„í• </label>
                            <input type="number" id="sfSplit" value="7" class="w-full border border-gray-300 rounded px-1 py-0.5 text-right text-sm font-bold text-gray-700 focus:ring-1 focus:ring-blue-400 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 mb-0.5 text-center">ë³´ìœ ì¼</label>
                            <input type="number" id="sfHold" value="40" class="w-full border border-gray-300 rounded px-1 py-0.5 text-right text-sm font-bold text-gray-700 focus:ring-1 focus:ring-blue-400 outline-none">
                        </div>
                    </div>
                </div>

                <!-- ê³µì„¸ ëª¨ë“œ -->
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold text-red-600 flex items-center gap-1.5 text-sm">
                            <span class="w-2.5 h-2.5 rounded-full bg-red-500"></span> ê³µì„¸ (AG)
                        </span>
                    </div>
                    <div class="grid grid-cols-4 gap-2">
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 mb-0.5 text-center">ë§¤ìˆ˜</label>
                            <input type="number" id="agLoc" value="3.6" step="0.1" class="w-full border border-gray-300 rounded px-1 py-0.5 text-right text-sm font-bold text-gray-700 focus:ring-1 focus:ring-red-400 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 mb-0.5 text-center">ë§¤ë„</label>
                            <input type="number" id="agProfit" value="5.6" step="0.1" class="w-full border border-gray-300 rounded px-1 py-0.5 text-right text-sm font-bold text-gray-700 focus:ring-1 focus:ring-red-400 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 mb-0.5 text-center">ë¶„í• </label>
                            <input type="number" id="agSplit" value="7" class="w-full border border-gray-300 rounded px-1 py-0.5 text-right text-sm font-bold text-gray-700 focus:ring-1 focus:ring-red-400 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-gray-500 mb-0.5 text-center">ë³´ìœ ì¼</label>
                            <input type="number" id="agHold" value="7" class="w-full border border-gray-300 rounded px-1 py-0.5 text-right text-sm font-bold text-gray-700 focus:ring-1 focus:ring-red-400 outline-none">
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. íˆ¬ìê¸ˆ ê°±ì‹  ì„¤ì • -->
            <div class="bg-white p-5 rounded-lg shadow-sm border-l-4 border-purple-500">
                <h2 class="font-bold text-lg mb-3 text-gray-700">3. íˆ¬ìê¸ˆ ê°±ì‹  ì„¤ì •</h2>
                <div class="space-y-3">
                    <!-- ê°±ì‹  ì£¼ê¸° -->
                    <div class="flex justify-between items-center border-b border-gray-100 pb-2 px-3">
                        <label class="text-xs font-bold text-gray-600">ê°±ì‹  ì£¼ê¸°</label>
                        <div class="flex items-center">
                            <input type="number" id="capitalCycle" value="10" class="w-16 border border-gray-300 rounded px-2 py-1 text-right text-sm focus:ring-2 focus:ring-purple-200 outline-none">
                            <span class="text-gray-500 text-xs ml-1 font-bold">ì¼</span>
                        </div>
                    </div>

                    <!-- ìˆ˜ìµ/ì†ì‹¤ ë°˜ì˜ë¥  -->
                    <div class="bg-purple-50 p-3 rounded-lg border border-purple-100 space-y-2">
                        <div class="flex justify-between items-center">
                            <label class="text-xs font-bold text-blue-700">ìˆ˜ìµ ì‹œ ë°˜ì˜ë¥ </label>
                            <div class="flex items-center">
                                <input type="number" id="reinvestRate" value="85" class="w-14 border border-gray-300 rounded px-1 py-1 text-right text-sm font-bold text-blue-600 bg-white focus:ring-1 focus:ring-blue-400 outline-none">
                                <span class="text-gray-500 text-[10px] ml-1">%</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <label class="text-xs font-bold text-red-600">ì†ì‹¤ ì‹œ ë°˜ì˜ë¥ </label>
                            <div class="flex items-center">
                                <input type="number" id="lossRate" value="35" class="w-14 border border-gray-300 rounded px-1 py-1 text-right text-sm font-bold text-red-500 bg-white focus:ring-1 focus:ring-red-400 outline-none">
                                <span class="text-gray-500 text-[10px] ml-1">%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. ì¸ì¶œì‹ ì„¤ì • (ì‹ ê·œ íŒ¨ë„) -->
            <div class="bg-white p-5 rounded-lg shadow-sm border-l-4 border-indigo-400">
                <h2 class="font-bold text-lg mb-1 text-gray-700">4. ì¸ì¶œì‹ ì„¤ì •</h2>
                
                <!-- ì–‘ë„ì„¸ ì¸ì¶œì „ëµ (ì—°ë‹¨ìœ„) ì²´í¬ë°•ìŠ¤ - mb-1ë¡œ ê°„ê²© ì¶•ì†Œ -->
                <div class="flex items-center gap-2 mb-1">
                    <input type="checkbox" id="enableAnnualWithdrawal" onclick="toggleWithdrawalCheckboxes('annual')" class="w-4 h-4 text-pink-600 rounded focus:ring-pink-500 border-gray-300 cursor-pointer">
                    <label for="enableAnnualWithdrawal" class="text-xs font-medium text-gray-700 select-none font-bold">ì–‘ë„ì„¸ ì¸ì¶œì „ëµ ì‚¬ìš©</label>
                </div>

                <!-- ê¸°ì¡´ ì¸ì¶œì‹ ê¸°ëŠ¥ ì‚¬ìš© ì²´í¬ë°•ìŠ¤ - mb-2ë¡œ ê°„ê²© ìµœì†Œí™” -->
                <div class="flex items-center gap-2 mb-2">
                    <input type="checkbox" id="enableWithdrawal" onclick="toggleWithdrawalCheckboxes('period')" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500 border-gray-300 cursor-pointer">
                    <label for="enableWithdrawal" class="text-xs font-medium text-gray-700 select-none font-bold">ê¸°ê°„ ì¸ì¶œ ì‚¬ìš©</label>
                </div>

                <div class="space-y-1"> <!-- space-y-1ë¡œ ê°„ê²© ìµœì†Œí™” -->
                    
                    <!-- ì¸ì¶œ ì‹œì‘ì¼ / ìµœëŒ€ ì¸ì¶œì¼ (2ì—´ ê·¸ë¦¬ë“œ, gap-1ë¡œ ì¶•ì†Œ) -->
                    <div class="grid grid-cols-2 gap-1 text-xs"> 
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-0.5">ì¸ì¶œ ì‹œì‘ì¼</label>
                            <input type="date" id="withdrawStartDate" value="2024-01-02" class="w-full border border-gray-300 rounded px-2 py-0.5 text-xs focus:ring-2 focus:ring-indigo-200 outline-none disabled:bg-gray-100 disabled:text-gray-400 disabled:cursor-not-allowed">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-0.5">ìµœëŒ€ ì¸ì¶œì¼</label>
                            <input type="date" id="withdrawEndDate" value="2025-12-03" class="w-full border border-gray-300 rounded px-2 py-0.5 text-xs focus:ring-2 focus:ring-indigo-200 outline-none disabled:bg-gray-100 disabled:text-gray-400 disabled:cursor-not-allowed">
                        </div>
                    </div>

                    <!-- ì¦ê°í•¨ìˆ˜ì§€ìˆ˜ (ë¶„ë¦¬ëœ í–‰, êµ¬ë¶„ì„  ì—†ìŒ) -->
                    <div class="text-xs"> 
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-0.5">ì¦ê°í•¨ìˆ˜ì§€ìˆ˜</label>
                            <input type="number" id="withdrawExponent" value="2.0" step="0.01" class="w-full border border-gray-300 rounded px-2 py-0.5 text-right text-xs focus:ring-2 focus:ring-indigo-200 outline-none">
                        </div>
                    </div>
                    
                    <!-- ì¸ì¶œë¥  ì‹œì‘/ìµœëŒ€ ì„¤ì • (ìœ„ì•„ë˜ ë¶„ë¦¬, ì •ìˆ˜ ì…ë ¥, íŒ¨ë”© ì—†ìŒ) -->
                    <div class="space-y-1 pt-0.5">
                        <!-- ì‹œì‘ ì¸ì¶œë¥  -->
                        <div class="flex justify-between items-center text-xs">
                            <label class="text-xs font-bold text-gray-600">ì‹œì‘ ì¸ì¶œë¥  (%)</label>
                            <div class="flex items-center">
                                <!-- ì •ìˆ˜ ì…ë ¥ step=1 -->
                                <input type="number" id="withdrawStartRate" value="0" step="1" class="w-12 border border-gray-300 rounded px-1 py-0.5 text-right text-xs font-bold text-gray-700 outline-none">
                                <span class="text-gray-500 text-[10px] ml-1">%</span>
                            </div>
                        </div>
                        <!-- ìµœëŒ€ ì¸ì¶œë¥  -->
                        <div class="flex justify-between items-center text-xs">
                            <label class="text-xs font-bold text-gray-600">ìµœëŒ€ ì¸ì¶œë¥  (%)</label>
                            <div class="flex items-center">
                                <!-- ì •ìˆ˜ ì…ë ¥ step=1 -->
                                <input type="number" id="withdrawMaxRate" value="50" step="1" class="w-12 border border-gray-300 rounded px-1 py-0.5 text-right text-xs font-bold text-gray-700 outline-none">
                                <span class="text-gray-500 text-[10px] ml-1">%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- ì‹¤í–‰ ë²„íŠ¼ -->
        <div class="text-center mb-10">
            <button onclick="runBacktest()" class="w-full md:w-1/2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-200 text-lg transform hover:-translate-y-0.5">
                ğŸš€ ì„¤ì •ê°’ìœ¼ë¡œ ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰
            </button>
        </div>

        <!-- ê²°ê³¼ ì˜ì—­ -->
        <div id="resultArea" class="hidden animate-fade-in">
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 mb-6">
                <div class="bg-white p-3 rounded shadow text-center border-t-4 border-indigo-500">
                    <p class="text-xs text-gray-500 font-bold uppercase">ìµœì¢… ìì‚°</p>
                    <p class="text-[10px] text-gray-400 h-3"></p>
                    <p id="resFinalValue" class="text-lg font-extrabold text-indigo-700 mt-1">-</p>
                </div>
                <div class="bg-white p-3 rounded shadow text-center border-t-4 border-gray-400">
                    <p class="text-xs text-gray-500 font-bold uppercase">ëˆ„ì  ìˆ˜ìµë¥ </p>
                    <p class="text-[10px] text-gray-400 h-3"></p>
                    <p id="resTotalReturn" class="text-lg font-extrabold mt-1">-</p>
                </div>
                <div class="bg-white p-3 rounded shadow text-center border-t-4 border-green-500">
                    <p class="text-xs text-gray-500 font-bold uppercase">CAGR</p>
                    <p class="text-[10px] text-gray-400">(ì—°í‰ê· ë³µë¦¬ìˆ˜ìµë¥ )</p>
                    <p id="resCagr" class="text-lg font-extrabold text-green-600 mt-1">-</p>
                </div>
                <div class="bg-white p-3 rounded shadow text-center border-t-4 border-red-500">
                    <p class="text-xs text-gray-500 font-bold uppercase">MDD</p>
                    <p class="text-[10px] text-gray-400">(ìµœëŒ€ë‚™í­)</p>
                    <p id="resMdd" class="text-lg font-extrabold text-red-600 mt-1">-</p>
                </div>
                <div class="bg-white p-3 rounded shadow text-center border-t-4 border-orange-400">
                    <p class="text-xs text-gray-500 font-bold uppercase">Pain Index</p>
                    <p class="text-[10px] text-gray-400">(ì¼í‰ê· DD)</p>
                    <p id="resPain" class="text-lg font-extrabold text-orange-500 mt-1">-</p>
                </div>
                <div class="bg-white p-3 rounded shadow text-center border-t-4 border-purple-500">
                    <p class="text-xs text-gray-500 font-bold uppercase">GPR</p>
                    <p class="text-[10px] text-gray-400">(CAGR / Pain Index)</p>
                    <p id="resGpr" class="text-lg font-extrabold text-purple-600 mt-1">-</p>
                </div>
                <div class="bg-white p-3 rounded shadow text-center border-t-4 border-pink-500">
                    <p class="text-xs text-gray-500 font-bold uppercase">Calmar Ratio</p>
                    <p class="text-[10px] text-gray-400">(CAGR / MDD)</p>
                    <p id="resCalmar" class="text-lg font-extrabold text-pink-600 mt-1">-</p>
                </div>
            </div>
            
            <!-- ì—°ë„ë³„ ì„±ê³¼ ë¶„ì„ í…Œì´ë¸” -->
            <div id="annualMetricsArea" class="bg-white p-4 rounded-lg shadow mb-6 border border-gray-200">
                <h3 class="font-bold text-lg mb-3 px-2 text-gray-700">ğŸ—“ï¸ ì—°ë„ë³„ ì„±ê³¼ ë¶„ì„</h3>
                <table class="min-w-full text-xs text-right border-collapse">
                    <thead>
                        <tr class="bg-gray-100 text-gray-600 uppercase border-b">
                            <th class="py-2 px-3 text-center">ì—°ë„</th>
                            <th class="py-2 px-2 text-right">ì‹œì‘ ìì‚° ($)</th>
                            <th class="py-2 px-2 text-right">ì¢…ë£Œ ìì‚° ($)</th>
                            <th class="py-2 px-2 text-right">ìˆ˜ìµë¥  (%)</th>
                            <th class="py-2 px-2 text-right">MDD (%)</th>
                            <th class="py-2 px-2 text-right">ì‹¤í˜„ìˆ˜ìµ ($)</th>
                            <th class="py-2 px-2 text-right">ì—°ë„ë³„ ì¸ì¶œì•¡ ($)</th>
                            <th class="py-2 px-2 text-right">ì¸ì¶œ/ìˆ˜ìµ ë¹„ìœ¨ (%)</th>
                        </tr>
                    </thead>
                    <tbody id="annualMetricsTableBody" class="text-gray-700 divide-y">
                        <!-- JSë¡œ ì±„ì›Œì§ -->
                    </tbody>
                </table>
            </div>

            <!-- ì°¨íŠ¸ ì˜ì—­ -->
            <div class="bg-white p-4 rounded-lg shadow mb-6 border border-gray-200" id="chartContainer">
                <h3 class="font-bold text-lg mb-2 px-2 text-gray-700">ğŸ“ˆ ìì‚° ë° ì£¼ê°€ ì¶”ì´</h3>
                <div class="relative h-[400px]">
                    <canvas id="strategyChart"></canvas>
                </div>
            </div>

            <!-- NEW: ë°˜ì˜ë¥  ë³€ë™ ì¶”ì´ ì°¨íŠ¸ -->
            <div class="bg-white p-4 rounded-lg shadow mb-6 border border-gray-200" id="rateChartContainer">
                <h3 class="font-bold text-lg mb-2 px-2 text-gray-700">ğŸ“Š ë°˜ì˜ë¥  ë³€ë™ ì¶”ì´ (Rates)</h3>
                <div class="relative h-[300px]">
                    <canvas id="rateChart"></canvas>
                </div>
            </div>

            <!-- ìƒì„¸ ë‚´ì—­ í…Œì´ë¸” -->
            <div class="bg-white p-4 rounded-lg shadow overflow-x-auto" id="tableContainer">
                <h3 class="font-bold text-lg mb-3 px-2 text-gray-700">ğŸ“„ ì¼ë³„ ìƒì„¸ ê±°ë˜ ë‚´ì—­ (ì „ì²´)</h3>
                <table class="min-w-full text-xs text-right border-collapse">
                    <thead>
                        <tr class="bg-gray-100 text-gray-600 uppercase border-b">
                            <th class="py-3 px-3 text-center sticky left-0 bg-gray-100 border-r z-10">ë‚ ì§œ</th>
                            <th class="py-3 px-2 text-right">ì¢…ê°€</th>
                            <th class="py-3 px-2 text-right">ë“±ë½</th>
                            <th class="py-3 px-2 text-center">ëª¨ë“œ</th>
                            <th class="py-3 px-2 text-right">íˆ¬ìê¸ˆ</th>
                            <th class="py-3 px-2 text-right">ë§¤ìˆ˜ì—¬ë ¥</th>
                            <th class="py-3 px-2 text-center text-blue-600 font-bold">ë§¤ìˆ˜ëŸ‰</th>
                            <th class="py-3 px-2 text-center">í¬íŠ¸</th>
                            <th class="py-3 px-2 bg-blue-50 text-blue-700">ëª©í‘œê°€</th>
                            <th class="py-3 px-2 text-center bg-red-50 text-red-700">ë§¤ë„ì¼</th>
                            <th class="py-3 px-2 text-center text-indigo-700 font-bold">ì¸ì¶œê¸ˆ</th>
                            <th class="py-3 px-2 font-bold">í‰ê°€ì•¡</th>
                            <th class="py-3 px-2 text-gray-400">ì˜ˆìˆ˜ê¸ˆ</th>
                            <th class="py-3 px-2">ì‹¤í˜„ìˆ˜ìµ</th>
                            <th class="py-3 px-2 text-gray-400">ë³´ìœ </th>
                            <th class="py-3 px-2 text-right text-gray-500 border-l">DD</th> <!-- DD ì»¬ëŸ¼ ì¶”ê°€ -->
                        </tr>
                    </thead>
                    <tbody id="logTableBody" class="text-gray-700 divide-y">
                        <!-- JSë¡œ ì¶”ê°€ë¨ -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ìŠ¤í¬ë¦½íŠ¸ ì˜ì—­ -->
    <script>
        // --- ìƒí˜¸ ë°°ì œ ì²´í¬ë°•ìŠ¤ ë¡œì§ (ë‚ ì§œ ì…ë ¥ì¹¸ ìƒíƒœ ì œì–´ ì¶”ê°€) ---
        function toggleWithdrawalCheckboxes(mode) {
            const annualCheckbox = document.getElementById('enableAnnualWithdrawal');
            const periodCheckbox = document.getElementById('enableWithdrawal');
            const startDateInput = document.getElementById('withdrawStartDate');
            const endDateInput = document.getElementById('withdrawEndDate');

            if (mode === 'annual') {
                if (annualCheckbox.checked) {
                    periodCheckbox.checked = false;
                    // ì–‘ë„ì„¸ ì „ëµ ì‚¬ìš© ì‹œ ë‚ ì§œ ì…ë ¥ ë¹„í™œì„±í™”
                    startDateInput.disabled = true;
                    endDateInput.disabled = true;
                } else {
                    // ì²´í¬ í•´ì œ ì‹œ ê¸°ë³¸ì ìœ¼ë¡œ í™œì„±í™”
                    startDateInput.disabled = false;
                    endDateInput.disabled = false;
                }
            } else if (mode === 'period') {
                if (periodCheckbox.checked) {
                    annualCheckbox.checked = false;
                    // ê¸°ê°„ ì¸ì¶œ ì‚¬ìš© ì‹œ ë‚ ì§œ ì…ë ¥ í™œì„±í™”
                    startDateInput.disabled = false;
                    endDateInput.disabled = false;
                } else {
                    // ê¸°ê°„ ì¸ì¶œ ì²´í¬ í•´ì œ ì‹œ.. ë§Œì•½ ì–‘ë„ì„¸ë„ ì²´í¬ ì•ˆë˜ì–´ ìˆë‹¤ë©´ í™œì„±í™”
                    if (!annualCheckbox.checked) {
                        startDateInput.disabled = false;
                        endDateInput.disabled = false;
                    }
                }
            }
        }
        // -----------------------------

        // --- ìƒìˆ˜ ë° ì „ì—­ ë³€ìˆ˜ ---
        const SHEET_ID = '1CY8hVPAXfPZZOfBgTaU5ygeLg4OXR14So_6dhfyoJjs';
        const SHEET_NAME = 'DBALL';
        const SEC_FEE_RATE = 0.0000278;
        const DECIMAL_4_START = new Date('2011-01-03');
        const DECIMAL_4_END = new Date('2021-03-01');
        
        let rawPriceData = [];
        let rawModeData = [];
        let chartInstance = null;
        let rateChartInstance = null; // NEW: ë°˜ì˜ë¥  ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤

        window.addEventListener('load', loadFromGoogleSheet);

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        function floorVal(val, decimals) {
            const factor = Math.pow(10, decimals);
            return Math.floor(val * factor) / factor;
        }

        function roundVal(val, decimals) {
            const factor = Math.pow(10, decimals);
            return Math.round(val * factor) / factor;
        }

        function parseDate(dateStr) {
            if (!dateStr) return null;
            let s = String(dateStr).trim();
            s = s.replace(/\s*\(.*\)\s*$/, '').replace(/\.$/, '').replace(/[\s,]/g, '').replace(/\u200B/g, '');
            s = s.replace(/[\.\/]/g, '-');
            const parts = s.split('-');
            if (parts.length === 3) {
                if (parts[0].length === 2) {
                    parts[0] = '20' + parts[0];
                }
            } else {
                return null;
            }
            const date = new Date(parts.join('-'));
            return isNaN(date.getTime()) ? null : date;
        }

        function formatNum(num, fixed=2) {
            return num.toLocaleString(undefined, {minimumFractionDigits: fixed, maximumFractionDigits: fixed});
        }

        // --- ë°ì´í„° ë¡œë“œ ---
        async function loadFromGoogleSheet() {
            const badge = document.getElementById('dbStatusBadge');
            const manualLink = document.getElementById('manualDownloadLink');
            
            badge.className = "flex items-center gap-2 text-sm font-bold text-indigo-600 animate-pulse bg-white px-3 py-1 rounded-full shadow-sm";
            badge.innerHTML = `
                <svg class="animate-spin h-4 w-4 text-indigo-500" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                ë°ì´í„° ë¡œë”© ì¤‘...
            `;
            if (manualLink) manualLink.classList.add('hidden');

            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0&t=${Date.now()}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("Network response was not ok");
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    complete: function(results) {
                        processCSV(results.data);
                    },
                    error: function(err) { throw err; }
                });
            } catch (error) {
                console.error("Data Load Error:", error);
                badge.className = "flex items-center gap-2 text-sm font-bold text-red-600 bg-white px-3 py-1 rounded-full shadow-sm cursor-pointer";
                badge.innerHTML = `âš ï¸ ë¡œë“œ ì‹¤íŒ¨ (ì—¬ê¸°ë¥¼ ëˆŒëŸ¬ ì¬ì‹œë„)`;
                badge.onclick = loadFromGoogleSheet;
                if (manualLink) manualLink.classList.remove('hidden');
            }
        }

        // CSV Upload Handler
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            Papa.parse(file, {
                complete: function(results) { processCSV(results.data); }
            });
        });

        function processCSV(data) {
            rawPriceData = [];
            rawModeData = [];

            const targetDateStr = '2025-08-15';
            let foundTargetDate = false;

            for (let i = 132; i < data.length; i++) {
                const row = data[i];
                if (!row[0] || !row[1]) continue;
                const date = parseDate(row[0]);
                const priceStr = String(row[1]).replace(/,/g, '');
                const price = parseFloat(priceStr);
                if (date && !isNaN(price)) {
                    rawPriceData.push({ date: date, close: price });
                    if (date.toISOString().slice(0, 10) === targetDateStr) foundTargetDate = true;
                }
            }
            
            for (let i = 3; i < data.length; i++) {
                const row = data[i];
                if (!row[4] || !row[7]) continue; 
                const date = parseDate(row[4]);
                const mode = row[7].trim();
                if (date && mode) rawModeData.push({ date: date, mode: mode });
            }

            rawPriceData.sort((a, b) => a.date - b.date);
            rawModeData.sort((a, b) => a.date - b.date);

            const badge = document.getElementById('dbStatusBadge');
            const manualLink = document.getElementById('manualDownloadLink');
            
            if (rawPriceData.length > 0) {
                const startY = rawPriceData[0].date.getFullYear();
                const endY = rawPriceData[rawPriceData.length-1].date.getFullYear();
                
                badge.className = "flex items-center gap-2 text-sm font-bold text-green-600 bg-white px-3 py-1 rounded-full shadow-sm";
                badge.innerHTML = `ğŸŸ¢ ë°ì´í„° ì¤€ë¹„ë¨ (${startY}~${endY})`;
                badge.onclick = null;
                if (manualLink) manualLink.classList.add('hidden');
            } else {
                badge.className = "flex items-center gap-2 text-sm font-bold text-yellow-600 bg-white px-3 py-1 rounded-full shadow-sm";
                badge.innerHTML = `âš ï¸ ë°ì´í„° ì—†ìŒ (í˜•ì‹ í™•ì¸ í•„ìš”)`;
            }
        }

        // --- Backtest Engine ---
        function runBacktest() {
            if (rawPriceData.length === 0) { alert("ë°ì´í„° ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”."); return; }

            const inputInitialCapital = parseFloat(document.getElementById('initialCapital').value.replace(/,/g, ''));
            const inputBrokerFee = parseFloat(document.getElementById('brokerFee').value);
            const useSecFee = document.getElementById('useSecFee').checked; 
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            endDate.setHours(23, 59, 59, 999); 

            const sf = {
                loc: 1 + (parseFloat(document.getElementById('sfLoc').value)/100),
                profit: 1 + (parseFloat(document.getElementById('sfProfit').value)/100),
                split: parseInt(document.getElementById('sfSplit').value),
                hold: parseInt(document.getElementById('sfHold').value)
            };
            const ag = {
                loc: 1 + (parseFloat(document.getElementById('agLoc').value)/100),
                profit: 1 + (parseFloat(document.getElementById('agProfit').value)/100),
                split: parseInt(document.getElementById('agSplit').value),
                hold: parseInt(document.getElementById('agHold').value)
            };
            
            const capitalCycle = parseInt(document.getElementById('capitalCycle').value);
            const reinvestRate = parseFloat(document.getElementById('reinvestRate').value) / 100;
            const lossRate = parseFloat(document.getElementById('lossRate').value) / 100;

            // --- ì¸ì¶œì‹ ì„¤ì • ë¡œë“œ ---
            const enableWithdrawal = document.getElementById('enableWithdrawal').checked;
            const enableAnnualWithdrawal = document.getElementById('enableAnnualWithdrawal').checked; 
            
            if (enableWithdrawal && enableAnnualWithdrawal) {
                 alert("ê¸°ê°„ ì¸ì¶œ ì‚¬ìš©ê³¼ ì—°ë‹¨ìœ„ ì¸ì¶œ ì‚¬ìš©ì€ ì¤‘ë³µ í™œì„±í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                 return;
            }

            const withdrawStartDate = new Date(document.getElementById('withdrawStartDate').value);
            const withdrawEndDate = new Date(document.getElementById('withdrawEndDate').value);
            const withdrawStartRate = parseFloat(document.getElementById('withdrawStartRate').value) / 100;
            const withdrawMaxRate = parseFloat(document.getElementById('withdrawMaxRate').value) / 100;
            const withdrawExponent = parseFloat(document.getElementById('withdrawExponent').value);
            
            const isWithdrawalMode = enableWithdrawal || enableAnnualWithdrawal; 
            
            function getWithdrawalRate(currentDate) {
                if (!isWithdrawalMode) return 0;
                let wStart = withdrawStartDate;
                let wEnd = withdrawEndDate;
                if (enableAnnualWithdrawal) {
                    const currentYear = currentDate.getFullYear();
                    const startYear = startDate.getFullYear();
                    wStart = new Date(currentYear, 0, 1); 
                    wEnd = new Date(currentYear, 11, 31); 
                    wEnd.setHours(23, 59, 59, 999);
                    if (currentYear === startYear) wStart = startDate;
                    if (currentDate < wStart) return 0;
                } else {
                    if (currentDate < wStart) return 0;
                    if (currentDate >= wEnd) return roundVal(withdrawMaxRate, 4);
                }
                if (currentDate >= wEnd) return roundVal(withdrawMaxRate, 4);
                
                const timeDiffStart = currentDate.getTime() - wStart.getTime();
                const totalTimeDiff = wEnd.getTime() - wStart.getTime(); 
                if (totalTimeDiff <= 0) return roundVal(withdrawMaxRate, 4);
                
                const progress = timeDiffStart / totalTimeDiff;
                const scaledProgress = Math.pow(progress, withdrawExponent);
                const rate = withdrawStartRate + (withdrawMaxRate - withdrawStartRate) * scaledProgress;
                return roundVal(rate, 4); 
            }

            let mergedData = [];
            let currentModeIdx = 0;
            let priceStartIndex = rawPriceData.findIndex(p => p.date >= startDate);
            if (priceStartIndex === -1) { alert("ì„ íƒëœ ì‹œì‘ì¼ ì´í›„ì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
            let loopStart = priceStartIndex > 0 ? priceStartIndex - 1 : priceStartIndex;

            for (let i = loopStart; i < rawPriceData.length; i++) {
                const p = rawPriceData[i];
                if (p.date > endDate) break;
                while (currentModeIdx < rawModeData.length - 1 && rawModeData[currentModeIdx + 1].date <= p.date) {
                    currentModeIdx++;
                }
                let mode = rawModeData.length > 0 ? rawModeData[currentModeIdx].mode : 'SF'; 
                if (rawModeData.length > 0 && p.date < rawModeData[0].date) mode = rawModeData[0].mode;
                mergedData.push({ date: p.date, close: p.close, mode: mode });
            }

            if (mergedData.length < 2) { alert("ë°±í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•œ ìµœì†Œ 2ì¼(ì „ì¼ ì¢…ê°€ ë° ì‹œì‘ì¼)ì˜ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."); return; } 

            let investCapital = inputInitialCapital;
            let cash = inputInitialCapital;
            let holdings = []; 
            let history = [];
            let daysSinceUpdate = 0;
            let periodProfit = 0;
            let cumulativeProfit = 0; 
            let cumulativeWithdrawal = 0; 

            for (let i = 1; i < mergedData.length; i++) {
                const curr = mergedData[i];
                const prev = mergedData[i-1];
                const date = curr.date;
                const close = curr.close;
                const prevClose = prev.close;
                const mode = curr.mode;
                
                let precPrice = 2, precSeed = 0;
                if (date >= DECIMAL_4_START && date <= DECIMAL_4_END) {
                    precPrice = 4; precSeed = 2;
                }
                const precWithdraw = precPrice + 2;
                const startHoldingsCnt = holdings.length;
                daysSinceUpdate++;

                // --- Rate Validation Logic (Fixed Ratio Logic Applied) ---
                let currentWithdrawRate = 0;
                if (isWithdrawalMode) {
                    currentWithdrawRate = getWithdrawalRate(date);
                }
                
                // 1. Calculate Adjusted Reinvest Rate (Simple Subtraction)
                let adjustedReinvestRate = reinvestRate - currentWithdrawRate;
                if (adjustedReinvestRate < 0) adjustedReinvestRate = 0;
                
                // 2. Calculate Reduction Ratio
                let reductionRatio = 0;
                if (reinvestRate > 0) {
                    reductionRatio = adjustedReinvestRate / reinvestRate;
                }
                
                // 3. Calculate Adjusted Loss Rate (Proportional Reduction)
                let adjustedLossRate = lossRate * reductionRatio;
                
                // Round for display/storage if needed, but keep precision for calc
                let effectiveReinvestRate = roundVal(adjustedReinvestRate, 4);
                let effectiveLossRate = roundVal(adjustedLossRate, 4);
                // ---------------------------------------------------------

                let buyingPower = cash;
                let nextHoldings = [];
                let soldToday = false;

                for (let h of holdings) {
                    let rule = (h.mode === 'SF' || h.mode === 'ì•ˆì „') ? sf : ag;
                    let targetPrice = roundVal(h.buyPrice * rule.profit, precPrice);
                    let isSold = false, sellPrice = 0;

                    if (h.daysHeld >= (rule.hold - 1)) { isSold = true; sellPrice = close; }
                    else if (close >= targetPrice) { isSold = true; sellPrice = close; }

                    if (isSold) {
                        let revenue = sellPrice * h.qty;
                        let feeBroker = floorVal(revenue * (inputBrokerFee/100), precPrice);
                        let feeSec = 0;
                        if (useSecFee) {
                            let tempSecFee = revenue * SEC_FEE_RATE;
                            feeSec = floorVal(tempSecFee, precPrice);
                        }
                        let fee = feeBroker + feeSec;
                        let netRev = revenue - fee;
                        let profit = netRev - (h.buyPrice * h.qty) - (h.buyFee || 0); 
                        let roundedProfit = roundVal(profit, precPrice);
                        let roundedNetRev = roundVal(netRev, precPrice);
                        cash = roundVal(cash + roundedNetRev, precPrice); 
                        cumulativeProfit += roundedProfit; 
                        periodProfit += profit; 
                        soldToday = true;
                        h.sellDate = date;
                    } else {
                        h.daysHeld++;
                        nextHoldings.push(h);
                    }
                }
                holdings = nextHoldings;

                let rule = (mode === 'SF' || mode === 'ì•ˆì „') ? sf : ag;
                let splitCnt = (mode === 'SF' || mode === 'ì•ˆì „') ? sf.split : ag.split;
                let targetBuyPrice = floorVal(prevClose * rule.loc, precPrice);
                let buyExecutedQty = 0;
                let newPort = null;

                if (startHoldingsCnt < splitCnt) {
                    if (close <= targetBuyPrice) {
                        let onePortCash = floorVal(investCapital / splitCnt, precSeed);
                        if (targetBuyPrice > 0) {
                            let qty = Math.floor(onePortCash / targetBuyPrice);
                            let estAmt = qty * targetBuyPrice;
                            let estFee = floorVal(estAmt * (inputBrokerFee/100), precPrice);
                            if ((estAmt + estFee) > buyingPower) {
                                qty = Math.floor(buyingPower / (targetBuyPrice * (1 + (inputBrokerFee/100))));
                            }
                            if (qty > 0) {
                                let buyAmt = qty * close;
                                let fee = floorVal(buyAmt * (inputBrokerFee/100), precPrice);
                                let totalCost = buyAmt + fee;
                                if (totalCost <= cash) {
                                    cash -= totalCost;
                                    cash = roundVal(cash, precPrice); 
                                    buyExecutedQty = qty;
                                    newPort = {
                                        buyDate: date, buyPrice: close, qty: qty, mode: mode, daysHeld: 0, buyFee: fee, sellDate: null
                                    };
                                    holdings.push(newPort);
                                }
                            }
                        }
                    }
                }

                let currentWithdrawnAmount = 0; 
                if (daysSinceUpdate >= capitalCycle) {
                    // Re-calculate daily withdrawal rate for the cycle check day
                    const dailyWithdrawRate = getWithdrawalRate(date);
                    
                    // --- Capital Update Logic with Proportional Loss Rate ---
                    let adjReinvest = reinvestRate - dailyWithdrawRate;
                    if(adjReinvest < 0) adjReinvest = 0;
                    
                    let redRatio = 0;
                    if(reinvestRate > 0) {
                        redRatio = adjReinvest / reinvestRate;
                    }
                    let adjLoss = lossRate * redRatio;
                    
                    // Use adjusted rates for capital update
                    let profitToReinvest = periodProfit * (periodProfit > 0 ? adjReinvest : adjLoss);
                    // --------------------------------------------------------
                    
                    if (isWithdrawalMode && periodProfit > 0.00000001) { 
                        currentWithdrawnAmount = roundVal(periodProfit * dailyWithdrawRate, precWithdraw);
                    }
                    
                    investCapital += profitToReinvest;
                    investCapital = roundVal(investCapital, precSeed);
                    
                    const isLastDayOfBacktest = date.getTime() >= endDate.getTime();
                    if (!enableAnnualWithdrawal || !isLastDayOfBacktest || date.getFullYear() === endDate.getFullYear()) {
                        cash = roundVal(cash - currentWithdrawnAmount, precPrice);
                    }
                    
                    cumulativeWithdrawal += currentWithdrawnAmount;
                    periodProfit = 0;
                    daysSinceUpdate = 0;
                }

                let stockVal = holdings.reduce((sum, h) => sum + (h.qty * close), 0);
                let totalQty = holdings.reduce((sum, h) => sum + h.qty, 0);
                let totalAsset = cash + stockVal;

                history.push({
                    date: date, close: close, mode: mode,
                    capital: investCapital, bp: buyingPower,
                    targetBuy: targetBuyPrice, buyQty: buyExecutedQty, newPort: newPort,
                    val: totalAsset, cash: cash, profit: cumulativeProfit,
                    qty: totalQty, cnt: holdings.length, sold: soldToday,
                    withdrawnAmount: currentWithdrawnAmount,
                    cumulativeWithdrawal: cumulativeWithdrawal,
                    // Store rates for the new chart
                    effReinvestRate: effectiveReinvestRate * 100, 
                    effLossRate: effectiveLossRate * 100,         
                    withdrawRate: currentWithdrawRate * 100,       
                    dd: 0 
                });
            }
            
            displayResults(history, inputInitialCapital);
        }

        function calculateAnnualMetrics(history, initialCapital) {
            if (history.length === 0) return [];
            let annualMetrics = [];
            let currentYear = history[0].date.getFullYear();
            let yearData = [];
            let startValue = initialCapital; 
            let startCumulativeProfit = 0; 
            let startCumulativeWithdrawal = 0; 
            
            for (let i = 0; i < history.length; i++) {
                const h = history[i];
                const year = h.date.getFullYear();
                if (year !== currentYear) {
                    if (yearData.length > 0) {
                        const endValue = yearData[yearData.length - 1].val;
                        const endCumulativeProfit = yearData[yearData.length - 1].profit; 
                        const endCumulativeWithdrawal = yearData[yearData.length - 1].cumulativeWithdrawal; 
                        const totalReturn = ((endValue - startValue) / startValue) * 100;
                        let maxPeak = startValue;
                        let annualMDD = 0;
                        yearData.forEach(d => {
                            if (d.val > maxPeak) maxPeak = d.val;
                            const dd = ((d.val - maxPeak) / maxPeak) * 100;
                            if (dd < annualMDD) annualMDD = dd;
                        });
                        const annualRealizedProfit = endCumulativeProfit - startCumulativeProfit;
                        const annualWithdrawal = endCumulativeWithdrawal - startCumulativeWithdrawal;
                        let withdrawalRatioVsProfit = 0;
                        if (annualRealizedProfit > 0) {
                            withdrawalRatioVsProfit = (annualWithdrawal / annualRealizedProfit) * 100;
                        }
                        annualMetrics.push({
                            year: currentYear, startValue: startValue, endValue: endValue,
                            annualReturn: totalReturn, annualMDD: annualMDD,
                            annualRealizedProfit: annualRealizedProfit, 
                            cumulativeWithdrawal: annualWithdrawal, 
                            withdrawalRatioVsProfit: withdrawalRatioVsProfit 
                        });
                        startValue = endValue;
                        startCumulativeProfit = endCumulativeProfit; 
                        startCumulativeWithdrawal = endCumulativeWithdrawal; 
                        currentYear = year;
                        yearData = [];
                    }
                }
                yearData.push(h);
            }
            if (yearData.length > 0) {
                const endValue = yearData[yearData.length - 1].val;
                const endCumulativeProfit = yearData[yearData.length - 1].profit;
                const endCumulativeWithdrawal = yearData[yearData.length - 1].cumulativeWithdrawal;
                const totalReturn = ((endValue - startValue) / startValue) * 100;
                let maxPeak = startValue;
                let annualMDD = 0;
                yearData.forEach(d => {
                    if (d.val > maxPeak) maxPeak = d.val;
                    const dd = ((d.val - maxPeak) / maxPeak) * 100;
                    if (dd < annualMDD) annualMDD = dd;
                });
                const annualRealizedProfit = endCumulativeProfit - startCumulativeProfit;
                const annualWithdrawal = endCumulativeWithdrawal - startCumulativeWithdrawal;
                let withdrawalRatioVsProfit = 0;
                if (annualRealizedProfit > 0) {
                    withdrawalRatioVsProfit = (annualWithdrawal / annualRealizedProfit) * 100;
                }
                annualMetrics.push({
                    year: currentYear, startValue: startValue, endValue: endValue,
                    annualReturn: totalReturn, annualMDD: annualMDD,
                    annualRealizedProfit: annualRealizedProfit,
                    cumulativeWithdrawal: annualWithdrawal,
                    withdrawalRatioVsProfit: withdrawalRatioVsProfit
                });
            }
            return annualMetrics;
        }

        function drawAnnualMetrics(annualMetrics) {
            const tbody = document.getElementById('annualMetricsTableBody');
            tbody.innerHTML = '';
            annualMetrics.forEach(m => {
                const returnClass = m.annualReturn >= 0 ? 'text-red-600 font-bold' : 'text-blue-600 font-bold';
                const mddClass = m.annualMDD >= 0 ? 'text-gray-600' : 'text-red-600';
                const profitClass = m.annualRealizedProfit >= 0 ? 'text-red-600 font-bold' : 'text-blue-600 font-bold';
                const ratioClass = m.withdrawalRatioVsProfit > 0 && m.withdrawalRatioVsProfit <= 100 ? 'text-purple-700 font-bold' : (m.withdrawalRatioVsProfit > 100 ? 'text-red-700 font-bold' : 'text-gray-400');
                const row = `
                    <tr class="hover:bg-gray-50 transition-colors border-b border-gray-100">
                        <td class="py-2 px-3 text-center font-bold">${m.year}</td>
                        <td class="py-2 px-2 text-right">${formatNum(m.startValue, 0)}</td>
                        <td class="py-2 px-2 text-right">${formatNum(m.endValue, 0)}</td>
                        <td class="py-2 px-2 text-right ${returnClass}">${formatNum(m.annualReturn, 2)}%</td>
                        <td class="py-2 px-2 text-right ${mddClass}">${formatNum(m.annualMDD, 2)}%</td>
                        <td class="py-2 px-2 text-right ${profitClass}">${formatNum(m.annualRealizedProfit, 0)}</td>
                        <td class="py-2 px-2 text-right text-indigo-700 font-bold">${formatNum(m.cumulativeWithdrawal, 2)}</td>
                        <td class="py-2 px-2 text-right ${ratioClass}">${formatNum(m.withdrawalRatioVsProfit, 2)}%</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function displayResults(history, startVal) {
            document.getElementById('resultArea').classList.remove('hidden');
            const last = history[history.length - 1];
            const endVal = last.val;
            const totalProfit = endVal - startVal;
            const ret = (totalProfit / startVal) * 100;
            const days = (last.date - history[0].date) / (1000 * 60 * 60 * 24);
            const years = days / 365.25;
            const cagr = years > 0 ? (Math.pow(endVal/startVal, 1/years) - 1) * 100 : 0;
            let maxPeak = -Infinity, mdd = 0, sumDD = 0;
            let dds = [];
            history.forEach(h => {
                if (h.val > maxPeak) maxPeak = h.val;
                let dd = (h.val - maxPeak) / maxPeak;
                if (dd < mdd) mdd = dd;
                sumDD += dd;
                dds.push(dd);
                h.dd = dd * 100; 
            });
            mdd *= 100;
            const painIndex = Math.abs(sumDD / history.length) * 100;
            const gpr = painIndex > 0 ? cagr / painIndex : 0;
            const calmar = mdd !== 0 ? cagr / Math.abs(mdd) : 0;

            document.getElementById('resFinalValue').innerText = `$${formatNum(endVal)}`;
            document.getElementById('resTotalReturn').innerText = `${formatNum(ret)}%`;
            document.getElementById('resTotalReturn').className = `text-xl font-extrabold mt-1 ${ret >= 0 ? 'text-red-500' : 'text-blue-600'}`;
            document.getElementById('resCagr').innerText = `${formatNum(cagr)}%`;
            document.getElementById('resMdd').innerText = `${formatNum(mdd)}%`;
            document.getElementById('resPain').innerText = `${formatNum(painIndex)}%`;
            document.getElementById('resGpr').innerText = formatNum(gpr);
            document.getElementById('resCalmar').innerText = formatNum(calmar);
            
            const annualMetrics = calculateAnnualMetrics(history, startVal);
            drawAnnualMetrics(annualMetrics);
            drawChart(history, dds);
            drawRateChart(history); // Call new chart
            drawTable(history);
        }

        function drawChart(history, dds) {
            const ctx = document.getElementById('strategyChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            const labels = history.map(h => h.date.toISOString().slice(0, 10));
            const dataVal = history.map(h => h.val);
            const dataClose = history.map(h => h.close);
            const dataDD = dds.map(d => d * 100);
            const dataWithdrawal = history.map(h => h.cumulativeWithdrawal);

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'ìì‚° ê°€ì¹˜ ($)', data: dataVal, borderColor: 'rgb(75, 192, 192)', backgroundColor: 'rgba(75, 192, 192, 0.1)', yAxisID: 'y', tension: 0.1, pointRadius: 0, fill: false },
                        { label: 'SOXL ì£¼ê°€ ($)', data: dataClose, borderColor: 'rgb(255, 99, 132)', yAxisID: 'y1', tension: 0.1, pointRadius: 1, borderWidth: 1, fill: false },
                        { label: 'ëˆ„ì  ì¸ì¶œì•¡ ($)', data: dataWithdrawal, borderColor: 'rgb(100, 100, 200)', backgroundColor: 'rgba(100, 100, 200, 0.1)', yAxisID: 'y', tension: 0.1, pointRadius: 0, fill: false },
                        { label: 'Drawdown (%)', data: dataDD, borderColor: 'rgba(153, 102, 255, 0.8)', backgroundColor: 'rgba(153, 102, 255, 0.2)', yAxisID: 'y2', type: 'line', fill: true, pointRadius: 0, borderWidth: 1 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { ticks: { maxTicksLimit: 8, maxRotation: 0 } },
                        y: { position: 'right', grid: { display: false }, title: { display: true, text: 'Asset Value / Withdrawal ($)' } },
                        y1: { position: 'left', grid: { color: '#f3f4f6' }, title: { display: true, text: 'SOXL Price ($)' } },
                        y2: { position: 'right', min: -100, max: 0, display: false }
                    },
                    plugins: { tooltip: { callbacks: { label: function(context) { let label = context.dataset.label || ''; if (label) label += ': '; if (context.parsed.y !== null) { label += formatNum(context.parsed.y); if (context.dataset.yAxisID === 'y2') label += '%'; } return label; } } } }
                }
            });
        }

        // --- NEW: ë°˜ì˜ë¥  ì°¨íŠ¸ ê·¸ë¦¬ê¸° í•¨ìˆ˜ ---
        function drawRateChart(history) {
            const ctx = document.getElementById('rateChart').getContext('2d');
            if (rateChartInstance) rateChartInstance.destroy();

            const labels = history.map(h => h.date.toISOString().slice(0, 10));
            const dataReinvest = history.map(h => h.effReinvestRate);
            const dataLoss = history.map(h => h.effLossRate);
            const dataWithdraw = history.map(h => h.withdrawRate);

            rateChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ìˆ˜ìµ ì‹œ ë°˜ì˜ë¥  (%)',
                            data: dataReinvest,
                            borderColor: 'rgb(34, 197, 94)', // Green-500
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: 'ì†ì‹¤ ì‹œ ë°˜ì˜ë¥  (%)',
                            data: dataLoss,
                            borderColor: 'rgb(239, 68, 68)', // Red-500
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: 'ì¸ì¶œë¥  (%)',
                            data: dataWithdraw,
                            borderColor: 'rgb(147, 51, 234)', // Purple-600
                            backgroundColor: 'rgba(147, 51, 234, 0.1)',
                            borderWidth: 1,
                            pointRadius: 0,
                            borderDash: [5, 5], // ì ì„ 
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { ticks: { maxTicksLimit: 8, maxRotation: 0 } },
                        y: { 
                            position: 'left',
                            title: { display: true, text: 'Rate (%)' },
                            min: 0, // ë¹„ìœ¨ì€ 0% ì´ìƒ
                            suggestedMax: 100 
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toFixed(4) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        function drawTable(history) {
            const tbody = document.getElementById('logTableBody');
            tbody.innerHTML = '';
            
            const rows = history.map((h, i) => {
                const dateStr = h.date.toISOString().slice(0, 10);
                let priceDecimals = 2;
                if (h.date >= DECIMAL_4_START && h.date <= DECIMAL_4_END) priceDecimals = 4;
                
                const modeClass = h.mode === 'AG' ? 'text-red-500 font-bold' : 'text-blue-500 font-bold';
                const buyClass = h.buyQty > 0 ? 'bg-blue-50 font-bold text-blue-600' : 'text-gray-300';
                
                let sellDateStr = '-';
                if (h.newPort) {
                    if (h.newPort.sellDate) sellDateStr = `<span class="text-red-600 font-bold">${h.newPort.sellDate.toISOString().slice(0, 10)}</span>`;
                    else sellDateStr = '<span class="text-gray-400 text-[10px]">ë³´ìœ ì¤‘</span>';
                }
                
                let precSeed = 0; 
                if (h.date >= DECIMAL_4_START && h.date <= DECIMAL_4_END) precSeed = 2;
                const withdrawnAmountStr = h.withdrawnAmount > 0 ? formatNum(h.withdrawnAmount, precSeed) : '-';
                const withdrawnClass = h.withdrawnAmount > 0 ? 'font-bold text-indigo-700 bg-indigo-50/50' : 'text-gray-400';
                const ddClass = h.dd < 0 ? 'text-blue-600' : 'text-gray-300';

                let changeRate = 0;
                if (i > 0) {
                    const prevClose = history[i-1].close;
                    changeRate = ((h.close - prevClose) / prevClose) * 100;
                }
                const changeClass = changeRate >= 0 ? 'text-red-600' : 'text-blue-600';
                const changeSign = changeRate >= 0 ? '+' : '';
                const profitClass = h.profit >= 0 ? 'text-red-600' : 'text-blue-600';

                return `
                    <tr class="hover:bg-gray-50 transition-colors border-b border-gray-100">
                        <td class="py-2 px-2 text-center text-xs text-gray-500 sticky left-0 bg-white border-r border-gray-100">${dateStr}</td>
                        <td class="py-2 px-2 text-right font-medium text-gray-700">${formatNum(h.close, priceDecimals)}</td>
                        <td class="py-2 px-2 text-right text-[11px] ${changeClass}">${changeSign}${formatNum(changeRate)}%</td>
                        <td class="py-2 px-2 text-center text-xs ${modeClass}">${h.mode}</td>
                        <td class="py-2 px-2 text-right text-gray-600 font-mono">${formatNum(h.capital, 0)}</td>
                        <td class="py-2 px-2 text-right text-gray-400 font-mono">${formatNum(h.bp, 0)}</td>
                        <td class="py-2 px-2 text-center ${buyClass}">${h.buyQty > 0 ? h.buyQty : '-'}</td>
                        <td class="py-2 px-2 text-center font-bold text-gray-600">${h.cnt}</td>
                        <td class="py-2 px-2 text-right text-blue-600 bg-blue-50/50 text-[11px]">${formatNum(h.targetBuy, priceDecimals)}</td>
                        <td class="py-2 px-2 text-center bg-red-50/50">${sellDateStr}</td>
                        <td class="py-2 px-2 text-right ${withdrawnAmountStr !== '-' ? withdrawnClass : 'text-gray-400'}">${withdrawnAmountStr}</td>
                        <td class="py-2 px-2 text-right font-bold text-gray-800">${formatNum(h.val, 0)}</td>
                        <td class="py-2 px-2 text-right text-gray-400 font-mono">${formatNum(h.cash, 0)}</td>
                        <td class="py-2 px-2 text-right font-medium ${profitClass}">${formatNum(h.profit, 0)}</td>
                        <td class="py-2 px-2 text-right text-gray-500">${formatNum(h.qty, 0)}</td>
                        <td class="py-2 px-2 text-right ${ddClass} border-l border-gray-100">${formatNum(h.dd, 2)}%</td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = rows;
        }
    </script>
</body>
</html>